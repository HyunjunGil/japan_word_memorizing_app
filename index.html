<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùºÎ≥∏Ïñ¥ Îã®Ïñ¥Ïû•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        #settingsBtn {
            font-size: 28px;
        }
        
        .content {
            padding: 40px;
        }
        
        .file-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .mode-selection {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
        }
        
        .mode-option {
            flex: 1;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .mode-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8e9ff 100%);
        }
        
        .mode-option input[type="radio"] {
            display: none;
        }
        
        .mode-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .mode-description {
            font-size: 14px;
            color: #666;
        }
        
        .mode-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }
        
        .upload-section input {
            display: none;
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-item:hover {
            background: #e8e9ff;
        }
        
        .file-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .file-item-info {
            flex: 1;
        }
        
        .file-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-item-count {
            font-size: 12px;
            color: #666;
        }
        
        .question-type-selection {
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .question-type-selection h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .question-type-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .question-type-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            user-select: none;
        }
        
        .question-type-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .question-type-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .question-type-option span {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-icon {
            width: 56px;
            height: 56px;
            padding: 0;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-icon.btn-primary {
            flex: 0 0 auto;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .flashcard {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .card {
            width: 100%;
            min-height: 300px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8e9ff 100%);
            border-radius: 16px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .weight-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .progress-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(118, 75, 162, 0.2);
            color: #764ba2;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .weight-value {
            font-size: 14px;
            color: #764ba2;
        }
        
        .progress-value {
            font-size: 14px;
            color: #667eea;
        }
        
        .card-question {
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .card-content {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        
        .card-answer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }
        
        .card-answer-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }
        
        .card-answer-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .card-answer-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .pronunciation-play-button {
            background: transparent;
            color: #667eea;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            margin-left: 10px;
            vertical-align: middle;
            transform: translateY(-2px);
        }
        
        .pronunciation-play-button:hover {
            background: #f8f9ff;
            border-color: #667eea;
            color: #764ba2;
        }
        
        .pronunciation-play-button:active {
            background: #e8e9ff;
        }
        
        .study-mode-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .study-item {
            padding: 25px 30px;
            background: white;
            border-radius: 12px;
            text-align: center;
        }
        
        .study-item-label {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .study-item-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .study-item.main {
            background: white;
        }
        
        .study-item.main .study-item-label {
            color: #667eea;
        }
        
        .study-item.main .study-item-value {
            color: #333;
            font-size: 40px;
        }
        
        .card-controls {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
            align-items: center;
        }
        
        .card-controls.align-left {
            justify-content: flex-start;
        }
        
        .card-controls.align-center {
            justify-content: center;
        }
        
        .card-controls.align-right {
            justify-content: flex-end;
        }
        
        .alignment-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 20;
            min-width: 120px;
        }
        
        .alignment-menu.show {
            display: flex;
        }
        
        .alignment-option {
            padding: 10px 15px;
            border: none;
            background: #f8f9ff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            transition: all 0.2s;
        }
        
        .alignment-option:hover {
            background: #e8e9ff;
        }
        
        .alignment-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .card-controls .btn:not(.btn-icon) {
            flex: 1;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .card-answer.hidden {
            display: flex;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .study-table-info {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #f8f9ff;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        .study-table-container {
            width: 100%;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .study-table {
            width: 100%;
            min-width: 1000px;
            border-collapse: collapse;
        }
        
        .study-table thead {
            position: sticky;
            top: 0;
            background: #f5f5f5;
            color: #333;
            z-index: 10;
            border-bottom: 2px solid #667eea;
        }
        
        .study-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .study-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
        }
        
        .study-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .study-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .study-table .id-cell {
            width: 60px;
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .study-table .japanese-cell {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .study-table th.japanese-cell {
            font-size: 14px;
        }
        
        .study-table th.id-cell,
        .study-table th.play-cell,
        .study-table th.pronunciation-cell,
        .study-table th.meaning-cell,
        .study-table th.sentence-cell {
            font-size: 14px;
        }
        
        .study-table th.sentence-cell {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .study-table th.sentence-cell:hover {
            background-color: #e8e9ff;
        }
        
        .study-table th.id-cell {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .study-table th.id-cell:hover {
            background-color: #e8e9ff;
        }
        
        .study-table .play-cell {
            width: 60px;
            text-align: center;
        }
        
        .study-table .play-button {
            background: transparent;
            color: #667eea;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }
        
        .study-table .play-button:hover {
            background: #f8f9ff;
            border-color: #667eea;
            color: #764ba2;
        }
        
        .study-table .play-button:active {
            background: #e8e9ff;
        }
        
        .study-table .japanese-cell {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .study-table .pronunciation-cell {
            color: #666;
            font-size: 16px;
        }
        
        .study-table .meaning-cell {
            color: #333;
        }
        
        .study-table .sentence-cell {
            min-width: 300px;
            max-width: 400px;
            color: #333;
            line-height: 1.6;
        }
        
        .study-table .sentence-jp {
            font-size: 16px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .study-table .sentence-kr {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        
        .study-table .japanese-cell,
        .study-table .pronunciation-cell,
        .study-table .meaning-cell,
        .study-table .sentence-cell {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .study-table .japanese-cell:hover,
        .study-table .pronunciation-cell:hover,
        .study-table .meaning-cell:hover,
        .study-table .sentence-cell:hover {
            background-color: #f0f0f0;
        }
        
        .study-table .japanese-cell.hidden-text,
        .study-table .pronunciation-cell.hidden-text,
        .study-table .meaning-cell.hidden-text,
        .study-table .sentence-cell.hidden-text {
            background-color: #e8e8e8;
            color: transparent;
            position: relative;
        }
        
        .study-table .japanese-cell.hidden-text::after,
        .study-table .pronunciation-cell.hidden-text::after,
        .study-table .meaning-cell.hidden-text::after,
        .study-table .sentence-cell.hidden-text::after {
            content: '‚Ä¢‚Ä¢‚Ä¢';
            color: #999;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .study-table th.japanese-cell,
        .study-table th.pronunciation-cell,
        .study-table th.meaning-cell {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .study-table th.japanese-cell:hover,
        .study-table th.pronunciation-cell:hover,
        .study-table th.meaning-cell:hover {
            background-color: #e8e9ff;
        }
        
        /* Î™®Î∞îÏùº Î∞òÏùëÌòï Ïä§ÌÉÄÏùº */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
            
            .container.study-mode {
                max-width: 100%;
            }
            
            .header {
                padding: 12px 15px;
                flex-wrap: nowrap;
                align-items: center;
            }
            
            .header h1 {
                font-size: 18px;
                flex: 0 1 auto;
                min-width: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-right: 10px;
            }
            
            .header-buttons {
                flex: 0 0 auto;
                gap: 6px;
                margin-top: 0;
                width: auto;
            }
            
            .header-btn {
                padding: 6px 10px;
                font-size: 11px;
                flex: 0 0 auto;
                min-width: auto;
                white-space: nowrap;
            }
            
            #settingsBtn {
                font-size: 22px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .mode-selection {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .mode-option {
                padding: 15px;
            }
            
            .mode-title {
                font-size: 16px;
            }
            
            .mode-description {
                font-size: 12px;
            }
            
            .mode-icon {
                font-size: 28px;
                margin-bottom: 8px;
            }
            
            .upload-section {
                padding: 20px 15px;
            }
            
            .file-list {
                max-height: 50vh;
            }
            
            .file-item {
                padding: 12px;
            }
            
            .file-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 12px;
            }
            
            .file-item-name {
                font-size: 14px;
            }
            
            .file-item-count {
                font-size: 11px;
            }
            
            .question-type-selection {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .question-type-selection h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .question-type-options {
                flex-direction: column;
                gap: 10px;
            }
            
            .question-type-option {
                padding: 8px 12px;
            }
            
            .question-type-option span {
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .card {
                min-height: 250px;
                padding: 25px 15px;
                gap: 15px;
            }
            
            .progress-badge {
                top: 10px;
                left: 10px;
                padding: 4px 10px;
                font-size: 11px;
            }
            
            .weight-badge {
                top: 10px;
                right: 10px;
                padding: 4px 10px;
                font-size: 11px;
            }
            
            .card-question {
                font-size: 12px;
            }
            
            .card-content {
                font-size: 32px;
                word-break: break-word;
            }
            
            .card-answer-item {
                padding: 12px;
            }
            
            .card-answer-value {
                font-size: 20px;
            }
            
            .pronunciation-play-button {
                width: 28px;
                height: 28px;
                font-size: 12px;
                margin-left: 8px;
            }
            
            .card-controls {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }
            
            .card-controls .btn {
                width: auto;
            }
            
            .card-controls .btn-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .alignment-menu {
                top: 100%;
                right: 0;
                margin-top: 5px;
                min-width: 100px;
                padding: 8px;
            }
            
            .alignment-option {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .study-item {
                padding: 20px 15px;
            }
            
            .study-item-value {
                font-size: 24px;
            }
            
            .study-item.main .study-item-value {
                font-size: 28px;
            }
            
            .study-table-info {
                padding: 10px 12px;
                font-size: 12px;
                margin-bottom: 12px;
            }
            
            .study-table-container {
                max-height: 70vh;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .study-table {
                min-width: 100%;
                font-size: 14px;
            }
            
            .study-table th {
                padding: 10px 8px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .study-table td {
                padding: 10px 8px;
                font-size: 14px;
            }
            
            .study-table .id-cell {
                width: 40px;
                font-size: 12px;
            }
            
            .study-table .play-cell {
                width: 50px;
            }
            
            .study-table .play-button {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .study-table .japanese-cell {
                font-size: 16px;
            }
            
            .study-table .pronunciation-cell {
                font-size: 13px;
            }
            
            .study-table .meaning-cell {
                font-size: 14px;
            }
            
            .study-table .sentence-cell {
                min-width: 200px;
                max-width: 300px;
            }
            
            .study-table .sentence-jp {
                font-size: 14px;
            }
            
            .study-table .sentence-kr {
                font-size: 12px;
            }
            
            .selection-controls {
                flex-direction: column;
            }
            
            .selection-controls .btn-secondary {
                width: 100%;
            }
        }
        
        /* ÏûëÏùÄ Î™®Î∞îÏùº ÌôîÎ©¥ (ÏÑ∏Î°ú Î™®Îìú) */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .header h1 {
                font-size: 16px;
                margin-right: 8px;
            }
            
            .header-btn {
                padding: 5px 8px;
                font-size: 10px;
            }
            
            #settingsBtn {
                font-size: 20px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .card-content {
                font-size: 28px;
            }
            
            .pronunciation-play-button {
                width: 26px;
                height: 26px;
                font-size: 11px;
                margin-left: 6px;
            }
            
            .study-table-info {
                padding: 8px 10px;
                font-size: 11px;
                margin-bottom: 10px;
            }
            
            .study-table th,
            .study-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .study-table .play-cell {
                width: 45px;
            }
            
            .study-table .play-button {
                width: 26px;
                height: 26px;
                font-size: 11px;
            }
            
            .study-table .japanese-cell {
                font-size: 14px;
            }
            
            .study-table .pronunciation-cell {
                font-size: 11px;
            }
            
            .study-table .meaning-cell {
                font-size: 12px;
            }
            
            .study-table .sentence-cell {
                min-width: 180px;
                max-width: 250px;
            }
            
            .study-table .sentence-jp {
                font-size: 12px;
            }
            
            .study-table .sentence-kr {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ÏùºÎ≥∏Ïñ¥ Îã®Ïñ¥Ïû•</h1>
            <div class="header-buttons">
                <button class="header-btn hidden" id="homeBtn" onclick="goHome()">Ï≤òÏùåÏúºÎ°ú</button>
                <button class="header-btn hidden" id="changeSetBtn" onclick="changeWordSet()">Îã®Ïñ¥ÏÖã Î≥ÄÍ≤Ω</button>
                <button class="header-btn hidden" id="startQuizBtn" onclick="startQuizFromStudy()">ÌèâÍ∞ÄÌïòÍ∏∞Î°ú</button>
                <button class="header-btn hidden" id="settingsBtn" onclick="toggleAlignmentMenu()">‚öô</button>
            </div>
            <div class="alignment-menu" id="alignmentMenu">
                <button class="alignment-option" onclick="setButtonAlignment('left')">‚¨Ö ÏôºÏ™Ω</button>
                <button class="alignment-option active" onclick="setButtonAlignment('center')">‚¨å Ï§ëÏïô</button>
                <button class="alignment-option" onclick="setButtonAlignment('right')">‚û° Ïò§Î•∏Ï™Ω</button>
            </div>
        </div>
        
        <div class="content">
            <!-- ÌååÏùº ÏÑ†ÌÉù ÌôîÎ©¥ -->
            <div id="fileSelectionScreen">
                <div class="file-selection">
                    <!-- Î™®Îìú ÏÑ†ÌÉù -->
                    <div class="mode-selection">
                        <label class="mode-option selected" onclick="selectMode('quiz')">
                            <input type="radio" name="studyMode" value="quiz" checked>
                            <div class="mode-icon">üìù</div>
                            <div class="mode-title">ÌèâÍ∞ÄÌïòÍ∏∞</div>
                            <div class="mode-description">ÎûúÎç§ Î¨∏Ï†úÎ°ú ÏïîÍ∏∞ ÌÖåÏä§Ìä∏</div>
                        </label>
                        <label class="mode-option" onclick="selectMode('study')">
                            <input type="radio" name="studyMode" value="study">
                            <div class="mode-icon">üìö</div>
                            <div class="mode-title">Í≥µÎ∂ÄÌïòÍ∏∞</div>
                            <div class="mode-description">Î™®Îì† Ï†ïÎ≥¥Î•º Î≥¥Î©∞ ÌïôÏäµ</div>
                        </label>
                    </div>
                    
                    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
                        <h3>üìÅ JSON ÌååÏùº ÏóÖÎ°úÎìú</h3>
                        <p style="margin-top: 10px; color: #666;">ÌÅ¥Î¶≠ÌïòÏó¨ Îã®Ïñ¥Î¨∂Ïùå ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
                        <input type="file" id="fileInput" accept=".json" multiple onchange="handleFileUpload(event)">
                    </div>
                    
                    <div id="fileListContainer" class="hidden">
                        <!-- Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù (ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎßå ÌëúÏãú) -->
                        <div id="questionTypeSelection" class="question-type-selection hidden">
                            <h3 style="margin-bottom: 15px;">Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù</h3>
                            <div class="question-type-options">
                                <label class="question-type-option">
                                    <input type="checkbox" id="questionTypeJapanese" checked>
                                    <span>ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞ Î¨∏Ï†ú</span>
                                </label>
                                <label class="question-type-option">
                                    <input type="checkbox" id="questionTypeMeaning" checked>
                                    <span>ÏùòÎØ∏ Î¨∏Ï†ú</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Îã®Ïñ¥Î¨∂Ïùå Î™©Î°ù</h3>
                            <div>
                                <button class="btn-secondary" style="padding: 8px 16px; margin-right: 10px;" onclick="selectAll()">Ï†ÑÏ≤¥ÏÑ†ÌÉù</button>
                                <button class="btn-secondary" style="padding: 8px 16px;" onclick="deselectAll()">Ï†ÑÏ≤¥Ìï¥Ï†ú</button>
                            </div>
                        </div>
                        <div class="file-list" id="fileList"></div>
                        <div class="selection-controls" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="startStudy()">ÌïôÏäµ ÏãúÏûë</button>
                        </div>
                    </div>
                    
                    <div id="emptyState" class="empty-state">
                        <h2>Îã®Ïñ¥Î¨∂ÏùåÏù¥ ÏóÜÏäµÎãàÎã§</h2>
                        <p>ÏúÑÏùò ÏóÖÎ°úÎìú Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ JSON ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
            
            <!-- ÌîåÎûòÏãúÏπ¥Îìú ÌôîÎ©¥ -->
            <div id="flashcardScreen" class="hidden">
                <div class="flashcard">
                    <div class="card">
                        <div class="progress-badge" id="progressBadge">
                            ÏßÑÌñâÎèÑ: <span class="progress-value" id="progressValue">0 / 0</span>
                        </div>
                        <div class="weight-badge" id="weightBadge">
                            Í∞ÄÏ§ëÏπò: <span class="weight-value" id="weightValue">1</span>
                        </div>
                        <div class="card-question" id="questionType"></div>
                        <div class="card-content" id="cardContent"></div>
                        <div class="card-answer hidden" id="cardAnswer"></div>
                    </div>
                    <div class="card-controls align-center" id="cardControls">
                        <button class="btn btn-icon btn-secondary" id="prevBtn" onclick="previousCard()" disabled>‚óÄ</button>
                        <button class="btn btn-icon btn-primary" id="showAnswerBtn" onclick="showAnswer()">?</button>
                        <button class="btn btn-icon btn-primary" id="nextBtn" onclick="nextCard()">‚ñ∂</button>
                    </div>
                </div>
            </div>
            
            <!-- Í≥µÎ∂ÄÌïòÍ∏∞ ÌÖåÏù¥Î∏î ÌôîÎ©¥ -->
            <div id="studyTableScreen" class="hidden">
                <div class="study-table-container" id="studyTableContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let wordSets = [];
        let selectedWords = [];
        let selectedQuestions = []; // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏö© Î¨∏Ï†ú Î∞∞Ïó¥
        let currentWordIndex = -1;
        let wordHistory = [];
        let currentQuestion = null;
        let answerShown = false;
        let weights = {};
        let studyMode = 'quiz'; // 'quiz' or 'study'
        let buttonAlignment = 'center'; // 'left', 'center', 'right'
        let longPressTimer = null; // Í∏¥ ÎàÑÎ¶Ñ ÌÉÄÏù¥Î®∏
        let longPressCompleted = false; // Í∏¥ ÎàÑÎ¶ÑÏù¥ ÏôÑÎ£åÎêòÏñ¥ Î≥µÏÇ¨ÎêòÏóàÎäîÏßÄ Ïó¨Î∂Ä
        let idSortOrder = 'asc'; // 'asc', 'desc', 'random' - ID Ï†ïÎ†¨ ÏàúÏÑú
        
        // Í∏∞Î≥∏ Îã®Ïñ¥ Îç∞Ïù¥ÌÑ∞Îäî results Ìè¥ÎçîÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Î°úÎìú
        const DEFAULT_WORD_SETS = [];
        
        // JSON ÌååÏùº Î°úÎìú Ìï®Ïàò
        async function loadWordSet(fileName) {
            try {
                const response = await fetch(`results/${fileName}.json`);
                if (!response.ok) {
                    console.warn(`ÌååÏùº ${fileName}.jsonÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                    return null;
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn(`ÌååÏùº ${fileName}.json Î°úÎìú Ïã§Ìå®:`, error);
                return null;
            }
        }
        
        // Ï¥àÍ∏∞Ìôî
        async function init() {
            initVoices();  // ÏùºÎ≥∏Ïñ¥ ÏùåÏÑ± Ï¥àÍ∏∞Ìôî
            
            // results Ìè¥ÎçîÏóêÏÑú JSON ÌååÏùºÎì§ Î°úÎìú (page_01.json ~ page_29.json)
            const wordSetPromises = [];
            for (let i = 1; i <= 29; i++) {
                const pageNum = String(i).padStart(2, '0');
                wordSetPromises.push(loadWordSet(`page_${pageNum}`));
            }
            
            const loadedWordSets = await Promise.all(wordSetPromises);
            // nullÏù¥ ÏïÑÎãå Í≤ÉÎßå ÌïÑÌÑ∞ÎßÅÌïòÏó¨ Ï∂îÍ∞Ä
            wordSets = loadedWordSets.filter(set => set !== null);
            
            // Ï¥àÍ∏∞ Î™®ÎìúÍ∞Ä 'quiz'Ïù¥ÎØÄÎ°ú Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù ÏòÅÏó≠ ÌëúÏãú
            const questionTypeSelection = document.getElementById('questionTypeSelection');
            if (studyMode === 'quiz') {
                questionTypeSelection.classList.remove('hidden');
            }
            
            renderFileList();
        }
        
        // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        async function handleFileUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (ÌååÏùºÎ™ÖÏúºÎ°ú)
                    const existingIndex = wordSets.findIndex(set => set.fileName === data.fileName);
                    if (existingIndex >= 0) {
                        wordSets[existingIndex] = data;
                    } else {
                        wordSets.push(data);
                    }
                    
                } catch (error) {
                    alert(`ÌååÏùº "${file.name}" Î°úÎìú Ïã§Ìå®: ${error.message}`);
                }
            }
            
            renderFileList();
            event.target.value = ''; // Í∞ôÏùÄ ÌååÏùº Ïû¨ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÎèÑÎ°ù
        }
        
        // Î™®Îìú ÏÑ†ÌÉù
        function selectMode(mode) {
            studyMode = mode;
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù ÏòÅÏó≠ ÌëúÏãú/Ïà®ÍπÄ
            const questionTypeSelection = document.getElementById('questionTypeSelection');
            if (mode === 'quiz') {
                questionTypeSelection.classList.remove('hidden');
            } else {
                questionTypeSelection.classList.add('hidden');
            }
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÎ°ú Î∞îÎÄåÎ©¥ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
            if (mode === 'study') {
                deselectAll();
            }
        }
        
        // ÌååÏùº Î™©Î°ù Î†åÎçîÎßÅ
        function renderFileList() {
            const fileList = document.getElementById('fileList');
            const fileListContainer = document.getElementById('fileListContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (wordSets.length === 0) {
                fileListContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            fileListContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // fileName ÏàúÏúºÎ°ú Ï†ïÎ†¨ (Ïà´Ïûê Î∂ÄÎ∂ÑÏùÑ Í≥†Î†§Ìïú ÏûêÏó∞ Ï†ïÎ†¨)
            const sortedWordSets = [...wordSets].sort((a, b) => {
                // fileNameÏóêÏÑú Ïà´Ïûê Î∂ÄÎ∂Ñ Ï∂îÏ∂ú
                const numA = parseInt(a.fileName.match(/\d+/)?.[0] || '0', 10);
                const numB = parseInt(b.fileName.match(/\d+/)?.[0] || '0', 10);
                return numA - numB;
            });
            
            fileList.innerHTML = sortedWordSets.map((set, index) => {
                // ÏõêÎ≥∏ Î∞∞Ïó¥ÏóêÏÑúÏùò Ïù∏Îç±Ïä§ Ï∞æÍ∏∞
                const originalIndex = wordSets.findIndex(s => s.fileName === set.fileName);
                return `
                <div class="file-item" onclick="toggleFileSelection(${originalIndex}, event)">
                    <input type="checkbox" id="file_${originalIndex}" onclick="event.stopPropagation()">
                    <div class="file-item-info">
                        <div class="file-item-name">${set.fileName}</div>
                        <div class="file-item-count">${set.words.length}Í∞ú Îã®Ïñ¥</div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // ÌååÏùº ÏÑ†ÌÉù ÌÜ†Í∏Ä
        function toggleFileSelection(index, event) {
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏßÅÏ†ë ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Îäî Ïù¥ÎØ∏ ÌÜ†Í∏ÄÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú ÏïÑÎ¨¥Í≤ÉÎèÑ ÏïàÌï®
            if (event && event.target.type === 'checkbox') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÎßå ÏÑ†ÌÉùÎêòÎèÑÎ°ù
                if (studyMode === 'study') {
                    const checkbox = event.target;
                    if (checkbox.checked) {
                        // Îã§Î•∏ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
                        wordSets.forEach((_, i) => {
                            if (i !== index) {
                                document.getElementById(`file_${i}`).checked = false;
                            }
                        });
                    }
                }
                return;
            }
            
            const checkbox = document.getElementById(`file_${index}`);
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÎßå ÏÑ†ÌÉùÎêòÎèÑÎ°ù
            if (studyMode === 'study') {
                if (checkbox.checked) {
                    // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ Ìï¥Ï†ú
                    checkbox.checked = false;
                } else {
                    // Îã§Î•∏ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú ÌõÑ ÌòÑÏû¨ Í≤ÉÎßå ÏÑ†ÌÉù
                    wordSets.forEach((_, i) => {
                        document.getElementById(`file_${i}`).checked = false;
                    });
                    checkbox.checked = true;
                }
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî Í∏∞Ï°¥ÎåÄÎ°ú ÌÜ†Í∏Ä
            checkbox.checked = !checkbox.checked;
            }
        }
        
        // Ï†ÑÏ≤¥ ÏÑ†ÌÉù
        function selectAll() {
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî Ï†ÑÏ≤¥ ÏÑ†ÌÉù Î∂àÍ∞Ä
            if (studyMode === 'study') {
                alert('Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑúÎäî ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            wordSets.forEach((_, index) => {
                document.getElementById(`file_${index}`).checked = true;
            });
        }
        
        // Ï†ÑÏ≤¥ Ìï¥Ï†ú
        function deselectAll() {
            wordSets.forEach((_, index) => {
                document.getElementById(`file_${index}`).checked = false;
            });
        }
        
        // ÌïôÏäµ ÏãúÏûë
        function startStudy() {
            selectedWords = [];
            selectedQuestions = [];
            let selectedFileCount = 0;
            let selectedSet = null;
            
            // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏùº Îïå ÏÑ†ÌÉùÎêú Î¨∏Ï†ú Ïú†Ìòï ÌôïÏù∏
            let selectedQuestionTypes = [];
            if (studyMode === 'quiz') {
                const japaneseChecked = document.getElementById('questionTypeJapanese').checked;
                const meaningChecked = document.getElementById('questionTypeMeaning').checked;
                
                if (!japaneseChecked && !meaningChecked) {
                    alert('ÏµúÏÜå ÌïòÎÇòÏùò Î¨∏Ï†ú Ïú†ÌòïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                if (japaneseChecked) {
                    selectedQuestionTypes.push({
                        type: 'japanese',
                        label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞'
                    });
                }
                if (meaningChecked) {
                    selectedQuestionTypes.push({
                        type: 'meaning',
                        label: 'Îúª'
                    });
                }
            }
            
            wordSets.forEach((set, index) => {
                const checkbox = document.getElementById(`file_${index}`);
                if (checkbox && checkbox.checked) {
                    selectedFileCount++;
                    selectedSet = set;
                    set.words.forEach(word => {
                        const wordData = {
                            ...word,
                            fileName: set.fileName,
                            weightKey: `${set.fileName}_${word.id}`
                        };
                        selectedWords.push(wordData);
                        
                        // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏùº Îïå ÏÑ†ÌÉùÎêú Î¨∏Ï†ú Ïú†ÌòïÎßå Î¨∏Ï†ú ÏÉùÏÑ±
                        if (studyMode === 'quiz') {
                            selectedQuestionTypes.forEach(questionType => {
                                selectedQuestions.push({
                                    word: wordData,
                                    questionType: questionType.type,
                                    questionLabel: questionType.label,
                                    weightKey: `${set.fileName}_${word.id}_${questionType.type}`
                                });
                            });
                        }
                    });
                }
            });
            
            if (selectedWords.length === 0) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÏùò ÌååÏùºÎßå ÏÑ†ÌÉùÎêòÏñ¥Ïïº Ìï®
            if (studyMode === 'study' && selectedFileCount > 1) {
                alert('Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑúÎäî ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            currentWordIndex = -1;
            wordHistory = [];
            weights = {}; // Í∞ÄÏ§ëÏπò Ï¥àÍ∏∞Ìôî (ÏÑ∏ÏÖò Ï§ëÏóêÎßå ÏÇ¨Ïö©)
            
            if (studyMode === 'quiz') {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: Í∞Å Î¨∏Ï†úÏùò Í∞ÄÏ§ëÏπòÎ•º 1Î°ú Ï¥àÍ∏∞Ìôî
                selectedQuestions.forEach(question => {
                    weights[question.weightKey] = 1;
                });
            } else {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: ÏÑ†ÌÉùÎêú Îã®Ïñ¥Îì§Ïùò Í∞ÄÏ§ëÏπòÎ•º 1Î°ú Ï¥àÍ∏∞Ìôî
                selectedWords.forEach(word => {
                    weights[word.weightKey] = 1;
                });
            }
            
            document.getElementById('fileSelectionScreen').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
            document.getElementById('changeSetBtn').classList.remove('hidden');
            
            if (studyMode === 'study') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Ï†ïÎ†¨ ÏàúÏÑú Ï¥àÍ∏∞Ìôî (Ïò§Î¶ÑÏ∞®Ïàú)
                idSortOrder = 'asc';
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Ïª®ÌÖåÏù¥ÎÑà ÎÑàÎπÑ ÌôïÏû•
                document.querySelector('.container').classList.add('study-mode');
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: ÌÖåÏù¥Î∏î ÌôîÎ©¥ ÌëúÏãú
                displayStudyTable(selectedSet);
                document.getElementById('studyTableScreen').classList.remove('hidden');
                document.getElementById('settingsBtn').classList.add('hidden');
                document.getElementById('changeSetBtn').classList.add('hidden');
                document.getElementById('startQuizBtn').classList.remove('hidden');
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: ÌîåÎûòÏãúÏπ¥Îìú ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('flashcardScreen').classList.remove('hidden');
                document.getElementById('settingsBtn').classList.remove('hidden');
                document.getElementById('startQuizBtn').classList.add('hidden');
                updateProgress(); // Ï¥àÍ∏∞ ÏßÑÌñâÎèÑ ÏÑ§Ï†ï
                nextCard();
            }
        }
        
        // Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ Î¨∏Ï†ú ÏÑ†ÌÉù (ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú)
        function getWeightedRandomQuestion() {
            // Í∞ÄÏ§ëÏπòÍ∞Ä 1 Ïù¥ÏÉÅÏù∏ Î¨∏Ï†úÎßå ÏÑ†ÌÉù ÎåÄÏÉÅÏóê Ìè¨Ìï®
            let availableQuestions = selectedQuestions.filter(question => {
                const weight = weights[question.weightKey];
                return weight !== undefined && weight > 0;
            });
            
            if (availableQuestions.length === 0) {
                return null; // Î™®Îì† Î¨∏Ï†úÍ∞Ä ÏôÑÎ£åÎê®
            }
            
            // ÏµúÍ∑º 5Í∞ú Îã®Ïñ¥ Ï†úÏô∏ Î°úÏßÅ (ÎÇ®ÏùÄ Îã®Ïñ¥Í∞Ä 5Í∞ú Ï¥àÍ≥ºÏùº ÎïåÎßå Ï†ÅÏö©)
            const RECENT_WORD_COUNT = 5;
            if (availableQuestions.length > RECENT_WORD_COUNT && wordHistory.length > 0) {
                // wordHistoryÏóêÏÑú ÏµúÍ∑º 5Í∞ú Ìï≠Î™©Ïùò Îã®Ïñ¥ ÏãùÎ≥ÑÏûê Ï∂îÏ∂ú
                const recentWords = new Set();
                const recentHistory = wordHistory.slice(-RECENT_WORD_COUNT);
                
                recentHistory.forEach(item => {
                    // fileNameÍ≥º idÎ•º Ï°∞Ìï©ÌïòÏó¨ Îã®Ïñ¥ ÏãùÎ≥ÑÏûê ÏÉùÏÑ±
                    if (item.fileName && item.id !== undefined) {
                        const wordKey = `${item.fileName}_${item.id}`;
                        recentWords.add(wordKey);
                    }
                });
                
                // ÏµúÍ∑º 5Í∞ú Îã®Ïñ¥Ïóê Ìï¥ÎãπÌïòÎäî Î¨∏Ï†úÎì§ÏùÑ Ï†úÏô∏
                const filteredQuestions = availableQuestions.filter(question => {
                    if (question.word && question.word.fileName && question.word.id !== undefined) {
                        const wordKey = `${question.word.fileName}_${question.word.id}`;
                        return !recentWords.has(wordKey);
                    }
                    return true; // fileNameÏù¥ÎÇò idÍ∞Ä ÏóÜÏúºÎ©¥ Ìè¨Ìï®
                });
                
                // ÌïÑÌÑ∞ÎßÅ ÌõÑ ÎÇ®ÏùÄ Î¨∏Ï†úÍ∞Ä 5Í∞ú Ï¥àÍ≥ºÏù¥Î©¥ ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥º ÏÇ¨Ïö©
                // 5Í∞ú Ïù¥ÌïòÎ©¥ ÏõêÎûò availableQuestions ÏÇ¨Ïö© (Ï§ëÎ≥µ Î∞©ÏßÄ ÎπÑÌôúÏÑ±Ìôî)
                if (filteredQuestions.length > RECENT_WORD_COUNT) {
                    availableQuestions = filteredQuestions;
                }
                // filteredQuestions.length <= RECENT_WORD_COUNTÏù∏ Í≤ΩÏö∞Îäî ÏõêÎûò availableQuestions ÏÇ¨Ïö©
            }
            
            const totalWeight = availableQuestions.reduce((sum, question) => {
                return sum + weights[question.weightKey];
            }, 0);
            
            if (totalWeight === 0) {
                return null; // Î™®Îì† Î¨∏Ï†úÍ∞Ä ÏôÑÎ£åÎê®
            }
            
            let random = Math.random() * totalWeight;
            
            for (let question of availableQuestions) {
                const weight = weights[question.weightKey];
                random -= weight;
                if (random <= 0) {
                    return question;
                }
            }
            
            return availableQuestions[0];
        }
        
        // Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ Îã®Ïñ¥ ÏÑ†ÌÉù (Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú)
        function getWeightedRandomWord() {
            const totalWeight = selectedWords.reduce((sum, word) => {
                return sum + (weights[word.weightKey] || 1);
            }, 0);
            
            let random = Math.random() * totalWeight;
            
            for (let word of selectedWords) {
                const weight = weights[word.weightKey] || 1;
                random -= weight;
                if (random <= 0) {
                    return word;
                }
            }
            
            return selectedWords[0];
        }
        
        // Îã§Ïùå Ïπ¥Îìú
        function nextCard() {
            // Ïä§ÌÉù Î∞©Ïãù: ÌòÑÏû¨ ÏúÑÏπò Ïù¥ÌõÑÏùò ÌûàÏä§ÌÜ†Î¶¨ Ï†úÍ±∞ (Ïù¥Ï†ÑÏúºÎ°ú Í∞îÎã§Í∞Ä Îã§Ïãú Îã§ÏùåÏùÑ ÎàÑÎ•∏ Í≤ΩÏö∞)
            const isGoingBackThenForward = currentWordIndex < wordHistory.length - 1;
            
            // Í∞ÄÏ§ëÏπò ÏóÖÎç∞Ïù¥Ìä∏ (Ïù¥Ï†ÑÏóêÏÑú Îã§ÏùåÏúºÎ°ú Í∞ÄÎäî Í≤ΩÏö∞Îäî Í∞ÄÏ§ëÏπò Î≥ÄÌôî ÏóÜÏùå)
            if (currentWordIndex >= 0 && !isGoingBackThenForward) {
                const currentItem = wordHistory[currentWordIndex];
                if (studyMode === 'study') {
                    // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Ìï≠ÏÉÅ Í∞ÄÏ§ëÏπò Ï¶ùÍ∞Ä
                    weights[currentItem.weightKey] = Math.min(5, (weights[currentItem.weightKey] || 1) + 1);
                } else {
                    // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú
                    if (!answerShown) {
                        // Ï†ïÎãµ ÌôïÏù∏ ÏóÜÏù¥ ÎÑòÏñ¥Í∞ê: Í∞ÄÏ§ëÏπò -1 (ÏµúÏÜå 0)
                        weights[currentItem.weightKey] = Math.max(0, (weights[currentItem.weightKey] || 1) - 1);
                    } else {
                        // Ï†ïÎãµ ÌôïÏù∏ ÌõÑ ÎÑòÏñ¥Í∞ê: Í∞ÄÏ§ëÏπò +1 (ÏµúÎåÄ 5)
                        weights[currentItem.weightKey] = Math.min(5, (weights[currentItem.weightKey] || 1) + 1);
                    }
                }
            }
            
            // Ïä§ÌÉù Î∞©Ïãù: ÌòÑÏû¨ ÏúÑÏπò Ïù¥ÌõÑÏùò ÌûàÏä§ÌÜ†Î¶¨ Ï†úÍ±∞
            if (isGoingBackThenForward) {
                wordHistory = wordHistory.slice(0, currentWordIndex + 1);
            }
            
            if (studyMode === 'quiz') {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: Î¨∏Ï†ú ÏÑ†ÌÉù
                const newQuestion = getWeightedRandomQuestion();
                if (!newQuestion) {
                    // Î™®Îì† Î¨∏Ï†ú ÏôÑÎ£å Ïãú ÏïåÎ¶º ÌëúÏãú ÌõÑ Ï≤òÏùåÏúºÎ°ú Ïù¥Îèô
                    alert('ÌïôÏäµÏùÑ ÏôÑÎ£åÌïòÏòÄÏäµÎãàÎã§!');
                    goHome();
                    return;
                }
                
                // Î¨∏Ï†ú Í∞ùÏ≤¥ ÏÉùÏÑ±
                const questionItem = {
                    ...newQuestion.word,
                    questionType: newQuestion.questionType,
                    questionLabel: newQuestion.questionLabel,
                    weightKey: newQuestion.weightKey
                };
                
                wordHistory.push(questionItem);
                currentWordIndex = wordHistory.length - 1;
            } else {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Îã®Ïñ¥ ÏÑ†ÌÉù
                const newWord = getWeightedRandomWord();
                wordHistory.push(newWord);
                currentWordIndex = wordHistory.length - 1;
            }
            
            displayCard();
            updateButtons();
            updateProgress();
        }
        
        // Ïù¥Ï†Ñ Ïπ¥Îìú
        function previousCard() {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                displayCard();
                updateButtons();
            }
        }
        
        // Ïπ¥Îìú ÌëúÏãú
        function displayCard() {
            const item = wordHistory[currentWordIndex];
            answerShown = false;
            
            // ÌòÑÏû¨ Ìï≠Î™©Ïùò Í∞ÄÏ§ëÏπò ÌëúÏãú
            const weightKey = item.weightKey;
            const currentWeight = weights[weightKey] || 1;
            document.getElementById('weightValue').textContent = currentWeight;
            
            if (studyMode === 'study') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Î™®Îì† Ï†ïÎ≥¥ ÌëúÏãú
                displayStudyMode(item);
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: Ï†ÄÏû•Îêú Î¨∏Ï†ú ÌëúÏãú
                displayQuizMode(item);
            }
            
            updateProgress();
        }
        
        // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú ÌëúÏãú
        function displayQuizMode(word) {
            // Î∞úÏùåÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (Îπà Î¨∏ÏûêÏó¥Ïù¥Í±∞ÎÇò ÏóÜÎäî Í≤ΩÏö∞ Ï†úÏô∏)
            const hasPronunciation = word.pronunciation && word.pronunciation.trim() !== '';
            
            // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï†ÄÏû•Îêú Î¨∏Ï†ú Ïú†ÌòïÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÎûúÎç§ ÏÑ†ÌÉù
            if (word.questionType && word.questionLabel) {
                // Ï†ÄÏû•Îêú Î¨∏Ï†ú Ïú†Ìòï ÏÇ¨Ïö©
                currentQuestion = {
                    type: word.questionType,
                    label: word.questionLabel,
                    value: word[word.questionType] // word.japanese ÎòêÎäî word.meaning
                };
            } else {
                // ÎûúÎç§ÏúºÎ°ú Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù (Î∞úÏùå Î¨∏Ï†úÎäî Ï†úÏô∏)
                const questionTypes = [
                    { type: 'japanese', label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞', value: word.japanese },
                    { type: 'meaning', label: 'Îúª', value: word.meaning }
                ];
                
                const randomIndex = Math.floor(Math.random() * questionTypes.length);
                currentQuestion = questionTypes[randomIndex];
                
                // Ï†ÄÏû• (Îã§ÏùåÏóê Í∞ôÏùÄ Îã®Ïñ¥Î•º Î≥º Îïå ÏÇ¨Ïö©)
                word.questionType = currentQuestion.type;
                word.questionLabel = currentQuestion.label;
            }
            
            document.getElementById('questionType').textContent = currentQuestion.label;
            document.getElementById('cardContent').textContent = currentQuestion.value;
            document.getElementById('cardContent').style.fontSize = '48px';
            
            // Îãµ Î∂ÄÎ∂ÑÎèÑ ÎØ∏Î¶¨ Î†åÎçîÎßÅÌïòÎêò hiddenÏúºÎ°ú ÏÑ§Ï†ï (Ïπ¥Îìú ÎÜíÏù¥ Ïú†ÏßÄ)
            // ÏàúÏÑú: ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞, Îúª, Î∞úÏùå (Î∞úÏùåÏù¥ Í∞ÄÏû• ÏïÑÎûò)
            const answers = [];
            if (currentQuestion.type !== 'japanese') {
                // ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞ Ìï≠Î™© Ï∂îÍ∞Ä
                // Î∞úÏùåÏù¥ ÏóÜÏúºÎ©¥ ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞ Ìï≠Î™©Ïóê Îì£Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä
                const hasPlayButtonForJapanese = !hasPronunciation;
                const playTextForJapanese = word.japanese;
                answers.push({ 
                    label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞', 
                    value: word.japanese, 
                    hasPlayButton: hasPlayButtonForJapanese,
                    playText: playTextForJapanese
                });
            }
            if (currentQuestion.type !== 'meaning') {
                answers.push({ label: 'Îúª', value: word.meaning, hasPlayButton: false });
            }
            if (currentQuestion.type !== 'pronunciation' && hasPronunciation) {
                // Î∞úÏùåÏù¥ ÏûàÏúºÎ©¥ Î∞úÏùå Ìï≠Î™©Ïóê Îì£Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä (Í∞ÄÏû• ÏïÑÎûò)
                const textToSpeak = word.pronunciation && word.pronunciation.trim() !== '' 
                    ? word.pronunciation 
                    : word.japanese;
                answers.push({ 
                    label: 'Î∞úÏùå', 
                    value: word.pronunciation, 
                    hasPlayButton: true,
                    playText: textToSpeak
                });
            }
            
            const answerHTML = answers.map(ans => {
                const playButton = ans.hasPlayButton 
                    ? `<button class="pronunciation-play-button" onclick="playPronunciation('${ans.playText.replace(/'/g, "\\'")}')" title="Î∞úÏùå Ïû¨ÏÉù">‚ñ∂</button>`
                    : '';
                return `
                <div class="card-answer-item">
                    <div class="card-answer-label">${ans.label}</div>
                    <div class="card-answer-value">${ans.value}${playButton}</div>
                </div>
            `;
            }).join('');
            
            document.getElementById('cardAnswer').innerHTML = answerHTML;
            document.getElementById('cardAnswer').classList.add('hidden');
            document.getElementById('showAnswerBtn').classList.remove('hidden');
            document.getElementById('showAnswerBtn').textContent = '?';
            answerShown = false; // Ï†ïÎãµ ÌëúÏãú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        }
        
        // Web Speech APIÎ°ú Î∞úÏùå Ïû¨ÏÉù (ChromeÏóêÏÑú Google ÏùºÎ≥∏Ïñ¥ ÏùåÏÑ± ÏÇ¨Ïö©)
        let jaVoice = null;
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏùºÎ≥∏Ïñ¥ ÏùåÏÑ± Ï∞æÍ∏∞
        function initVoices() {
            const setVoice = () => {
                const voices = speechSynthesis.getVoices();
                // Google ÏùºÎ≥∏Ïñ¥ ÏùåÏÑ± Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Îã§Î•∏ ÏùºÎ≥∏Ïñ¥ ÏùåÏÑ± ÏÇ¨Ïö©
                jaVoice = voices.find(v => v.name === 'Google Êó•Êú¨Ë™û') 
                       || voices.find(v => v.lang.startsWith('ja'));
            };
            
            setVoice();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = setVoice;
            }
        }
        
        function playPronunciation(text) {
            if (!text || text.trim() === '') {
                return;
            }
            
            // Ïù¥Ï†Ñ Î∞úÌôî Ï§ëÎã®
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            
            if (jaVoice) {
                utterance.voice = jaVoice;
            }
            
            utterance.rate = 0.9;  // ÏïΩÍ∞Ñ ÎäêÎ¶¨Í≤å (ÌïôÏäµÏö©)
            utterance.pitch = 1;
            
            utterance.onerror = (e) => {
                console.error('Î∞úÏùå Ïû¨ÏÉù Ïã§Ìå®:', e);
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // ÌòÑÏû¨ ÌÖåÏù¥Î∏îÏùò Î≥¥ÏûÑ/Ïà®ÍπÄ ÏÉÅÌÉú Ï†ÄÏû•
        function saveCellVisibilityStates() {
            const states = {};
            const rows = document.querySelectorAll('.study-table tbody tr');
            rows.forEach(row => {
                const idCell = row.querySelector('.id-cell');
                if (!idCell) return;
                const wordId = idCell.textContent.trim();
                
                const japaneseCell = row.querySelector('.japanese-cell');
                const pronunciationCell = row.querySelector('.pronunciation-cell');
                const meaningCell = row.querySelector('.meaning-cell');
                const sentenceCell = row.querySelector('.sentence-cell');
                
                if (japaneseCell) {
                    states[`${wordId}_japanese`] = japaneseCell.classList.contains('hidden-text');
                }
                if (pronunciationCell) {
                    states[`${wordId}_pronunciation`] = pronunciationCell.classList.contains('hidden-text');
                }
                if (meaningCell) {
                    states[`${wordId}_meaning`] = meaningCell.classList.contains('hidden-text');
                }
                if (sentenceCell) {
                    states[`${wordId}_sentence`] = sentenceCell.classList.contains('hidden-text');
                }
            });
            return states;
        }
        
        // Ï†ÄÏû•Îêú Î≥¥ÏûÑ/Ïà®ÍπÄ ÏÉÅÌÉú Î≥µÏõê
        function restoreCellVisibilityStates(states) {
            const rows = document.querySelectorAll('.study-table tbody tr');
            rows.forEach(row => {
                const idCell = row.querySelector('.id-cell');
                if (!idCell) return;
                const wordId = idCell.textContent.trim();
                
                const japaneseCell = row.querySelector('.japanese-cell');
                const pronunciationCell = row.querySelector('.pronunciation-cell');
                const meaningCell = row.querySelector('.meaning-cell');
                const sentenceCell = row.querySelector('.sentence-cell');
                
                if (japaneseCell) {
                    const key = `${wordId}_japanese`;
                    if (states[key]) {
                        japaneseCell.classList.add('hidden-text');
                    } else {
                        japaneseCell.classList.remove('hidden-text');
                    }
                }
                if (pronunciationCell) {
                    const key = `${wordId}_pronunciation`;
                    if (states[key]) {
                        pronunciationCell.classList.add('hidden-text');
                    } else {
                        pronunciationCell.classList.remove('hidden-text');
                    }
                }
                if (meaningCell) {
                    const key = `${wordId}_meaning`;
                    if (states[key]) {
                        meaningCell.classList.add('hidden-text');
                    } else {
                        meaningCell.classList.remove('hidden-text');
                    }
                }
                if (sentenceCell) {
                    const key = `${wordId}_sentence`;
                    if (states[key]) {
                        sentenceCell.classList.add('hidden-text');
                    } else {
                        sentenceCell.classList.remove('hidden-text');
                    }
                }
            });
        }
        
        // ID Ï†ïÎ†¨ ÏàúÏÑú Î≥ÄÍ≤Ω
        function toggleIdSort() {
            // ÌòÑÏû¨ Î≥¥ÏûÑ/Ïà®ÍπÄ ÏÉÅÌÉú Ï†ÄÏû•
            const visibilityStates = saveCellVisibilityStates();
            
            if (idSortOrder === 'asc') {
                idSortOrder = 'desc';
            } else if (idSortOrder === 'desc') {
                idSortOrder = 'random';
            } else {
                idSortOrder = 'asc';
            }
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îã®Ïñ¥ÏÖãÏúºÎ°ú ÌÖåÏù¥Î∏î Îã§Ïãú ÌëúÏãú
            const selectedSet = wordSets.find(set => {
                const checkbox = document.getElementById(`file_${wordSets.indexOf(set)}`);
                return checkbox && checkbox.checked;
            });
            if (selectedSet) {
                displayStudyTable(selectedSet);
                // Î≥¥ÏûÑ/Ïà®ÍπÄ ÏÉÅÌÉú Î≥µÏõê
                setTimeout(() => {
                    restoreCellVisibilityStates(visibilityStates);
                }, 0);
            }
        }
        
        // Í≥µÎ∂ÄÌïòÍ∏∞ ÌÖåÏù¥Î∏î ÌëúÏãú
        function displayStudyTable(wordSet) {
            const container = document.getElementById('studyTableContainer');
            
            // Ï†ïÎ†¨Îêú Îã®Ïñ¥ Î∞∞Ïó¥ ÏÉùÏÑ±
            let sortedWords = [...wordSet.words];
            if (idSortOrder === 'asc') {
                sortedWords.sort((a, b) => a.id - b.id);
            } else if (idSortOrder === 'desc') {
                sortedWords.sort((a, b) => b.id - a.id);
            } else if (idSortOrder === 'random') {
                // Fisher-Yates ÏÖîÌîå ÏïåÍ≥†Î¶¨Ï¶ò
                for (let i = sortedWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [sortedWords[i], sortedWords[j]] = [sortedWords[j], sortedWords[i]];
                }
            }
            
            // Ï†ïÎ†¨ ÏàúÏÑú ÌëúÏãú ÏïÑÏù¥ÏΩò
            let sortIcon = '';
            if (idSortOrder === 'asc') {
                sortIcon = ' ‚Üë';
            } else if (idSortOrder === 'desc') {
                sortIcon = ' ‚Üì';
            } else {
                sortIcon = ' ‚Üï';
            }
            
            const infoHTML = `
                <div class="study-table-info">
                    Í∞Å ÌÖçÏä§Ìä∏Î•º ÌÅ¥Î¶≠ÌïòÏó¨ Î≥¥ÏûÑ/Ïà®ÍπÄ Ï≤òÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§<br>
                    ÌÖçÏä§Ìä∏Î•º Í∏∏Í≤å ÎàÑÎ•¥Î©¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨Îê©ÎãàÎã§
                </div>
            `;
            
            const tableHTML = `
                <table class="study-table">
                    <thead>
                        <tr>
                            <th class="id-cell" onclick="toggleIdSort()" style="cursor: pointer;" title="ID Ï†ïÎ†¨ Î≥ÄÍ≤Ω">ID${sortIcon}</th>
                            <th class="play-cell">Ïû¨ÏÉù</th>
                            <th class="japanese-cell" onclick="toggleColumn('japanese')">ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞</th>
                            <th class="pronunciation-cell" onclick="toggleColumn('pronunciation')">Î∞úÏùå</th>
                            <th class="meaning-cell" onclick="toggleColumn('meaning')">ÏùòÎØ∏</th>
                            <th class="sentence-cell" onclick="toggleColumn('sentence')">ÏòàÎ¨∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedWords.map((word, index) => {
                            // Î∞úÏùåÏù¥ ÏûàÏúºÎ©¥ Î∞úÏùåÏùÑ, ÏóÜÏúºÎ©¥ ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞Î•º ÏÇ¨Ïö©
                            const textToSpeak = word.pronunciation && word.pronunciation.trim() !== '' 
                                ? word.pronunciation 
                                : word.japanese;
                            
                            // ÏòàÎ¨∏Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                            const hasSentence = word.sent_jp && word.sent_jp.trim() !== '' && word.sent_kr && word.sent_kr.trim() !== '';
                            const sentenceText = hasSentence ? `${word.sent_jp}\n${word.sent_kr}` : '';
                            
                            const sentenceCellHTML = hasSentence ? `
                                <td class="sentence-cell" onclick="toggleCell(this, event)" 
                                    onmousedown="startLongPress(this, '${sentenceText.replace(/'/g, "\\'")}')" 
                                    onmouseup="endLongPress()" 
                                    onmouseleave="endLongPress()"
                                    ontouchstart="startLongPress(this, '${sentenceText.replace(/'/g, "\\'")}')" 
                                    ontouchend="endLongPress()" 
                                    ontouchcancel="endLongPress()"
                                    ontouchmove="endLongPress()">
                                    <div class="sentence-jp">${word.sent_jp}</div>
                                    <div class="sentence-kr">${word.sent_kr}</div>
                                </td>
                            ` : `<td class="sentence-cell">-</td>`;
                            
                            return `
                            <tr>
                                <td class="id-cell">${word.id}</td>
                                <td class="play-cell">
                                    <button class="play-button" onclick="playPronunciation('${textToSpeak.replace(/'/g, "\\'")}')" title="Î∞úÏùå Ïû¨ÏÉù">‚ñ∂</button>
                                </td>
                                <td class="japanese-cell" onclick="toggleCell(this, event)" 
                                    onmousedown="startLongPress(this, '${word.japanese.replace(/'/g, "\\'")}')" 
                                    onmouseup="endLongPress()" 
                                    onmouseleave="endLongPress()"
                                    ontouchstart="startLongPress(this, '${word.japanese.replace(/'/g, "\\'")}')" 
                                    ontouchend="endLongPress()" 
                                    ontouchcancel="endLongPress()"
                                    ontouchmove="endLongPress()">${word.japanese}</td>
                                <td class="pronunciation-cell" onclick="toggleCell(this, event)" 
                                    onmousedown="startLongPress(this, '${word.pronunciation.replace(/'/g, "\\'")}')" 
                                    onmouseup="endLongPress()" 
                                    onmouseleave="endLongPress()"
                                    ontouchstart="startLongPress(this, '${word.pronunciation.replace(/'/g, "\\'")}')" 
                                    ontouchend="endLongPress()" 
                                    ontouchcancel="endLongPress()"
                                    ontouchmove="endLongPress()">${word.pronunciation}</td>
                                <td class="meaning-cell" onclick="toggleCell(this, event)" 
                                    onmousedown="startLongPress(this, '${word.meaning.replace(/'/g, "\\'")}')" 
                                    onmouseup="endLongPress()" 
                                    onmouseleave="endLongPress()"
                                    ontouchstart="startLongPress(this, '${word.meaning.replace(/'/g, "\\'")}')" 
                                    ontouchend="endLongPress()" 
                                    ontouchcancel="endLongPress()"
                                    ontouchmove="endLongPress()">${word.meaning}</td>
                                ${sentenceCellHTML}
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = infoHTML + tableHTML;
        }
        
        // ÏÖÄ ÌÅ¥Î¶≠ Ïãú ÌÖçÏä§Ìä∏ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        let clickTimer = null;
        function toggleCell(cell, event) {
            // Ïù¥Î≤§Ìä∏Í∞Ä Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏúºÎ©¥ Í∏∞Î≥∏ ÎèôÏûë
            if (!event) {
                cell.classList.toggle('hidden-text');
                return;
            }
            
            // Í∏¥ ÎàÑÎ¶ÑÏúºÎ°ú Î≥µÏÇ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏúºÎ©¥ ÌÜ†Í∏ÄÌïòÏßÄ ÏïäÏùå
            if (longPressCompleted) {
                longPressCompleted = false; // ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
                return;
            }
            
            // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º ÏïΩÍ∞Ñ ÏßÄÏó∞ÏãúÏºúÏÑú Í∏¥ ÎàÑÎ¶ÑÍ≥º Íµ¨Î∂Ñ
            if (clickTimer) {
                clearTimeout(clickTimer);
            }
            
            clickTimer = setTimeout(() => {
                // Í∏¥ ÎàÑÎ¶ÑÏù¥ ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏùÑ ÎïåÎßå ÌÜ†Í∏Ä
                if (longPressTimer === null && !longPressCompleted) {
                    cell.classList.toggle('hidden-text');
                }
                clickTimer = null;
            }, 100);
        }
        
        // Í∏¥ ÎàÑÎ¶Ñ ÏãúÏûë
        function startLongPress(cell, text) {
            // Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏Í∞Ä ÏûàÏúºÎ©¥ Ï∑®ÏÜå
            if (longPressTimer !== null) {
                clearTimeout(longPressTimer);
            }
            
            // ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            longPressCompleted = false;
            
            // ÌÅ¥Î¶≠ ÌÉÄÏù¥Î®∏ Ï∑®ÏÜå (Í∏¥ ÎàÑÎ¶ÑÏù¥ ÏãúÏûëÎêòÎ©¥ ÌÅ¥Î¶≠ Î¨¥Ïãú)
            if (clickTimer !== null) {
                clearTimeout(clickTimer);
                clickTimer = null;
            }
            
            // 500ms ÌõÑ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
            longPressTimer = setTimeout(() => {
                copyToClipboard(text);
                longPressTimer = null;
                longPressCompleted = true; // Î≥µÏÇ¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                
                // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞± (ÏÑ†ÌÉù Ìö®Í≥º)
                cell.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                }, 200);
            }, 500);
        }
        
        // Í∏¥ ÎàÑÎ¶Ñ Ï¢ÖÎ£å
        function endLongPress() {
            // ÌÉÄÏù¥Î®∏Í∞Ä ÏïÑÏßÅ Ïã§Ìñâ Ï§ëÏù¥Î©¥ Ï∑®ÏÜå (Î≥µÏÇ¨ÎêòÏßÄ ÏïäÏùå)
            if (longPressTimer !== null) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
                longPressCompleted = false; // Î≥µÏÇ¨ÎêòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
            }
            // ÌÉÄÏù¥Î®∏Í∞Ä nullÏù¥Î©¥ Ïù¥ÎØ∏ Î≥µÏÇ¨Í∞Ä ÏôÑÎ£åÎêú ÏÉÅÌÉúÏù¥ÎØÄÎ°ú ÌîåÎûòÍ∑∏Îäî Ïú†ÏßÄ
        }
        
        // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
        async function copyToClipboard(text) {
            try {
                // Clipboard API ÏÇ¨Ïö© (ÏµúÏã† Î∏åÎùºÏö∞Ï†Ä)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    showCopyFeedback('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
                } else {
                    // Íµ¨Ìòï Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê: ÏûÑÏãú textarea ÏÇ¨Ïö©
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showCopyFeedback('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
                }
            } catch (error) {
                console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', error);
                showCopyFeedback('Î≥µÏÇ¨ Ïã§Ìå®', true);
            }
        }
        
        // Î≥µÏÇ¨ ÌîºÎìúÎ∞± ÌëúÏãú
        function showCopyFeedback(message, isError = false) {
            // Í∏∞Ï°¥ ÌîºÎìúÎ∞±Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingFeedback = document.getElementById('copyFeedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            // ÌîºÎìúÎ∞± ÏöîÏÜå ÏÉùÏÑ±
            const feedback = document.createElement('div');
            feedback.id = 'copyFeedback';
            feedback.textContent = message;
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? '#f8d7da' : '#d4edda'};
                color: ${isError ? '#721c24' : '#155724'};
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 16px;
                font-weight: bold;
                pointer-events: none;
                animation: fadeInOut 1.5s ease-in-out;
            `;
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä (ÏïÑÏßÅ ÏóÜÏúºÎ©¥)
            if (!document.getElementById('copyFeedbackStyle')) {
                const style = document.createElement('style');
                style.id = 'copyFeedbackStyle';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(feedback);
            
            // 1.5Ï¥à ÌõÑ Ï†úÍ±∞
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 1500);
        }
        
        // Ìó§Îçî ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ Ïª¨Îüº Ï†ÑÏ≤¥ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        function toggleColumn(columnType) {
            const cells = document.querySelectorAll(`.study-table tbody .${columnType}-cell`);
            const allHidden = Array.from(cells).every(cell => cell.classList.contains('hidden-text'));
            
            cells.forEach(cell => {
                if (allHidden) {
                    // Î™®Îëê Ïà®Í≤®Ï†∏ ÏûàÏúºÎ©¥ Î™®Îëê Î≥¥Ïù¥Í≤å
                    cell.classList.remove('hidden-text');
                } else {
                    // ÌïòÎÇòÎùºÎèÑ Î≥¥Ïù¥Î©¥ Î™®Îëê Ïà®Í∏∞Í∏∞
                    cell.classList.add('hidden-text');
                }
            });
        }
        
        // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú ÌëúÏãú (ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî Ìï®Ïàò - Ïú†ÏßÄ)
        function displayStudyMode(word) {
            currentQuestion = { type: 'all' }; // Î™®Îì† Ï†ïÎ≥¥ ÌëúÏãú
            
            document.getElementById('questionType').textContent = 'Í≥µÎ∂ÄÌïòÍ∏∞';
            
            const studyHTML = `
                <div class="study-mode-card">
                    <div class="study-item main">
                        <div class="study-item-label">ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞</div>
                        <div class="study-item-value">${word.japanese}</div>
                    </div>
                    <div class="study-item">
                        <div class="study-item-label">Î∞úÏùå</div>
                        <div class="study-item-value">${word.pronunciation}</div>
                    </div>
                    <div class="study-item">
                        <div class="study-item-label">Îúª</div>
                        <div class="study-item-value">${word.meaning}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('cardContent').innerHTML = studyHTML;
            document.getElementById('cardContent').style.fontSize = 'inherit';
            document.getElementById('cardAnswer').classList.add('hidden');
            document.getElementById('showAnswerBtn').classList.add('hidden');
            document.getElementById('nextBtn').textContent = 'Îã§ÏùåÏúºÎ°ú';
        }
        
        // ÏßÑÌñâÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress() {
            if (studyMode !== 'quiz' || selectedQuestions.length === 0) {
                return;
            }
            
            const totalQuestions = selectedQuestions.length;
            const completedQuestions = selectedQuestions.filter(question => {
                const weight = weights[question.weightKey];
                return weight !== undefined && weight === 0;
            }).length;
            
            document.getElementById('progressValue').textContent = `${completedQuestions} / ${totalQuestions}`;
        }
        
        // Ï†ïÎãµ ÌôïÏù∏/Ïà®Í∏∞Í∏∞ ÌÜ†Í∏Ä
        function showAnswer() {
            const cardAnswer = document.getElementById('cardAnswer');
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            
            if (answerShown) {
                // Ï†ïÎãµÏù¥ Î≥¥Ïó¨Ï†∏ ÏûàÏúºÎ©¥ Ïà®Í∏∞Í∏∞
                cardAnswer.classList.add('hidden');
                showAnswerBtn.textContent = '?';
                answerShown = false;
            } else {
                // Ï†ïÎãµÏù¥ Ïà®Í≤®Ï†∏ ÏûàÏúºÎ©¥ Î≥¥Ïó¨Ï£ºÍ∏∞
                cardAnswer.classList.remove('hidden');
                showAnswerBtn.textContent = '‚úì';
                answerShown = true;
                // Í∞ÄÏ§ëÏπòÎäî nextCard()ÏóêÏÑúÎßå Î≥ÄÍ≤Ω
            }
        }
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateButtons() {
            document.getElementById('prevBtn').disabled = currentWordIndex === 0;
        }
        
        // Ï≤òÏùåÏúºÎ°ú
        function goHome() {
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelector('.container').classList.remove('study-mode');
            document.getElementById('flashcardScreen').classList.add('hidden');
            document.getElementById('studyTableScreen').classList.add('hidden');
            document.getElementById('fileSelectionScreen').classList.remove('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
            document.getElementById('changeSetBtn').classList.add('hidden');
            document.getElementById('startQuizBtn').classList.add('hidden');
            document.getElementById('settingsBtn').classList.add('hidden');
            
            // Î™®Îìú Ï¥àÍ∏∞Ìôî
            studyMode = 'quiz';
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÍ∞Ä Í∏∞Î≥∏ ÏÑ†ÌÉùÎêòÎèÑÎ°ù ÏÑ§Ï†ï
            const quizOption = document.querySelector('.mode-option[onclick*="quiz"]');
            if (quizOption) {
                quizOption.classList.add('selected');
            }
            // ÎùºÎîîÏò§ Î≤ÑÌäºÎèÑ Ï¥àÍ∏∞Ìôî
            const quizRadio = document.querySelector('input[value="quiz"]');
            const studyRadio = document.querySelector('input[value="study"]');
            if (quizRadio) quizRadio.checked = true;
            if (studyRadio) studyRadio.checked = false;
            
            // Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù ÏòÅÏó≠ ÌëúÏãú
            const questionTypeSelection = document.getElementById('questionTypeSelection');
            questionTypeSelection.classList.remove('hidden');
            
            // Î¨∏Ï†ú Ïú†Ìòï Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî (Îëò Îã§ Ï≤¥ÌÅ¨)
            document.getElementById('questionTypeJapanese').checked = true;
            document.getElementById('questionTypeMeaning').checked = true;
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
            deselectAll();
        }
        
        // Í≥µÎ∂ÄÌïòÍ∏∞ÏóêÏÑú ÌèâÍ∞ÄÌïòÍ∏∞Î°ú Ï†ÑÌôò
        function startQuizFromStudy() {
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelector('.container').classList.remove('study-mode');
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îã®Ïñ¥ÏÖãÏúºÎ°ú ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú ÏãúÏûë
            selectedQuestions = [];
            
            // ÏÑ†ÌÉùÎêú Î¨∏Ï†ú Ïú†Ìòï ÌôïÏù∏ (Í∏∞Î≥∏Í∞í: Îëò Îã§ Ï≤¥ÌÅ¨)
            const japaneseChecked = document.getElementById('questionTypeJapanese')?.checked !== false;
            const meaningChecked = document.getElementById('questionTypeMeaning')?.checked !== false;
            
            let selectedQuestionTypes = [];
            if (japaneseChecked) {
                selectedQuestionTypes.push({
                    type: 'japanese',
                    label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞'
                });
            }
            if (meaningChecked) {
                selectedQuestionTypes.push({
                    type: 'meaning',
                    label: 'Îúª'
                });
            }
            
            // ÏÑ†ÌÉùÎêú Î¨∏Ï†ú Ïú†ÌòïÏù¥ ÏóÜÏúºÎ©¥ Îëò Îã§ ÏÇ¨Ïö©
            if (selectedQuestionTypes.length === 0) {
                selectedQuestionTypes = [
                    { type: 'japanese', label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞' },
                    { type: 'meaning', label: 'Îúª' }
                ];
            }
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îã®Ïñ¥Îì§Î°ú ÏÑ†ÌÉùÎêú Î¨∏Ï†ú Ïú†ÌòïÎßå Î¨∏Ï†ú ÏÉùÏÑ±
            selectedWords.forEach(word => {
                selectedQuestionTypes.forEach(questionType => {
                    selectedQuestions.push({
                        word: word,
                        questionType: questionType.type,
                        questionLabel: questionType.label,
                        weightKey: `${word.fileName}_${word.id}_${questionType.type}`
                    });
                });
            });
            
            // Í∞ÄÏ§ëÏπò Ï¥àÍ∏∞Ìôî: Í∞Å Î¨∏Ï†úÏùò Í∞ÄÏ§ëÏπòÎ•º 1Î°ú ÏÑ§Ï†ï
            weights = {};
            selectedQuestions.forEach(question => {
                weights[question.weightKey] = 1;
            });
            
            // Î™®Îìú Î≥ÄÍ≤Ω
            studyMode = 'quiz';
            
            // ÌôîÎ©¥ Ï†ÑÌôò
            document.getElementById('studyTableScreen').classList.add('hidden');
            document.getElementById('flashcardScreen').classList.remove('hidden');
            document.getElementById('startQuizBtn').classList.add('hidden');
            document.getElementById('changeSetBtn').classList.remove('hidden');
            document.getElementById('settingsBtn').classList.remove('hidden');
            
            // ÌïôÏäµ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            currentWordIndex = -1;
            wordHistory = [];
            
            // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú ÏãúÏûë
            updateProgress();
            nextCard();
        }
        
        // Îã®Ïñ¥ÏÖã Î≥ÄÍ≤Ω
        function changeWordSet() {
            if (confirm('ÌòÑÏû¨ ÌïôÏäµÏùÑ Ï§ëÎã®ÌïòÍ≥† Îã®Ïñ¥ÏÖãÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
                document.querySelector('.container').classList.remove('study-mode');
                document.getElementById('flashcardScreen').classList.add('hidden');
                document.getElementById('studyTableScreen').classList.add('hidden');
                document.getElementById('fileSelectionScreen').classList.remove('hidden');
                document.getElementById('changeSetBtn').classList.add('hidden');
                document.getElementById('startQuizBtn').classList.add('hidden');
                document.getElementById('settingsBtn').classList.add('hidden');
            }
        }
        
        // Î≤ÑÌäº Ï†ïÎ†¨ Î©îÎâ¥ ÌÜ†Í∏Ä
        function toggleAlignmentMenu() {
            const menu = document.getElementById('alignmentMenu');
            menu.classList.toggle('show');
        }
        
        // Î≤ÑÌäº Ï†ïÎ†¨ ÏÑ§Ï†ï
        function setButtonAlignment(alignment) {
            buttonAlignment = alignment;
            const cardControls = document.getElementById('cardControls');
            const menu = document.getElementById('alignmentMenu');
            const options = menu.querySelectorAll('.alignment-option');
            
            // Î™®Îì† ÏòµÏÖòÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            options.forEach(option => option.classList.remove('active'));
            
            // ÏÑ†ÌÉùÌïú ÏòµÏÖòÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            if (alignment === 'left') {
                cardControls.className = 'card-controls align-left';
                options[0].classList.add('active');
            } else if (alignment === 'center') {
                cardControls.className = 'card-controls align-center';
                options[1].classList.add('active');
            } else if (alignment === 'right') {
                cardControls.className = 'card-controls align-right';
                options[2].classList.add('active');
            }
            
            // Î©îÎâ¥ Îã´Í∏∞
            menu.classList.remove('show');
        }
        
        // Î©îÎâ¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('alignmentMenu');
            const settingsBtn = document.getElementById('settingsBtn');
            
            if (menu && settingsBtn && !menu.contains(event.target) && !settingsBtn.contains(event.target)) {
                menu.classList.remove('show');
            }
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = init;
    </script>
</body>
</html>