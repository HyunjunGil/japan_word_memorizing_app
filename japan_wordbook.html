<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùºÎ≥∏Ïñ¥ Îã®Ïñ¥Ïû•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .content {
            padding: 40px;
        }
        
        .file-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .mode-selection {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
        }
        
        .mode-option {
            flex: 1;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .mode-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8e9ff 100%);
        }
        
        .mode-option input[type="radio"] {
            display: none;
        }
        
        .mode-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .mode-description {
            font-size: 14px;
            color: #666;
        }
        
        .mode-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }
        
        .upload-section input {
            display: none;
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-item:hover {
            background: #e8e9ff;
        }
        
        .file-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .file-item-info {
            flex: 1;
        }
        
        .file-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-item-count {
            font-size: 12px;
            color: #666;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .flashcard {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .card {
            width: 100%;
            min-height: 300px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8e9ff 100%);
            border-radius: 16px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .weight-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .weight-value {
            font-size: 14px;
            color: #764ba2;
        }
        
        .card-question {
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .card-content {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        
        .card-answer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }
        
        .card-answer-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .card-answer-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .card-answer-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .study-mode-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .study-item {
            padding: 25px 30px;
            background: white;
            border-radius: 12px;
            text-align: center;
        }
        
        .study-item-label {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .study-item-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .study-item.main {
            background: white;
        }
        
        .study-item.main .study-item-label {
            color: #667eea;
        }
        
        .study-item.main .study-item-value {
            color: #333;
            font-size: 40px;
        }
        
        .card-controls {
            display: flex;
            gap: 15px;
            width: 100%;
        }
        
        .card-controls .btn {
            flex: 1;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .study-table-container {
            width: 100%;
            max-height: 600px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .study-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .study-table thead {
            position: sticky;
            top: 0;
            background: #f5f5f5;
            color: #333;
            z-index: 10;
            border-bottom: 2px solid #667eea;
        }
        
        .study-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .study-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
        }
        
        .study-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .study-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .study-table .id-cell {
            width: 60px;
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .study-table .japanese-cell {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .study-table .pronunciation-cell {
            color: #666;
            font-size: 16px;
        }
        
        .study-table .meaning-cell {
            color: #333;
        }
        
        /* Î™®Î∞îÏùº Î∞òÏùëÌòï Ïä§ÌÉÄÏùº */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
            
            .header {
                padding: 12px 15px;
                flex-wrap: nowrap;
                align-items: center;
            }
            
            .header h1 {
                font-size: 18px;
                flex: 0 1 auto;
                min-width: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-right: 10px;
            }
            
            .header-buttons {
                flex: 0 0 auto;
                gap: 6px;
                margin-top: 0;
                width: auto;
            }
            
            .header-btn {
                padding: 6px 10px;
                font-size: 11px;
                flex: 0 0 auto;
                min-width: auto;
                white-space: nowrap;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .mode-selection {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .mode-option {
                padding: 15px;
            }
            
            .mode-title {
                font-size: 16px;
            }
            
            .mode-description {
                font-size: 12px;
            }
            
            .mode-icon {
                font-size: 28px;
                margin-bottom: 8px;
            }
            
            .upload-section {
                padding: 20px 15px;
            }
            
            .file-list {
                max-height: 50vh;
            }
            
            .file-item {
                padding: 12px;
            }
            
            .file-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 12px;
            }
            
            .file-item-name {
                font-size: 14px;
            }
            
            .file-item-count {
                font-size: 11px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .card {
                min-height: 250px;
                padding: 25px 15px;
                gap: 15px;
            }
            
            .weight-badge {
                top: 10px;
                right: 10px;
                padding: 4px 10px;
                font-size: 11px;
            }
            
            .card-question {
                font-size: 12px;
            }
            
            .card-content {
                font-size: 32px;
                word-break: break-word;
            }
            
            .card-answer-item {
                padding: 12px;
            }
            
            .card-answer-value {
                font-size: 20px;
            }
            
            .card-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .card-controls .btn {
                width: 100%;
            }
            
            .study-item {
                padding: 20px 15px;
            }
            
            .study-item-value {
                font-size: 24px;
            }
            
            .study-item.main .study-item-value {
                font-size: 28px;
            }
            
            .study-table-container {
                max-height: 70vh;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .study-table {
                min-width: 100%;
                font-size: 14px;
            }
            
            .study-table th {
                padding: 10px 8px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .study-table td {
                padding: 10px 8px;
                font-size: 14px;
            }
            
            .study-table .id-cell {
                width: 40px;
                font-size: 12px;
            }
            
            .study-table .japanese-cell {
                font-size: 16px;
            }
            
            .study-table .pronunciation-cell {
                font-size: 13px;
            }
            
            .study-table .meaning-cell {
                font-size: 14px;
            }
            
            .selection-controls {
                flex-direction: column;
            }
            
            .selection-controls .btn-secondary {
                width: 100%;
            }
        }
        
        /* ÏûëÏùÄ Î™®Î∞îÏùº ÌôîÎ©¥ (ÏÑ∏Î°ú Î™®Îìú) */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .header h1 {
                font-size: 16px;
                margin-right: 8px;
            }
            
            .header-btn {
                padding: 5px 8px;
                font-size: 10px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .card-content {
                font-size: 28px;
            }
            
            .study-table th,
            .study-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .study-table .japanese-cell {
                font-size: 14px;
            }
            
            .study-table .pronunciation-cell {
                font-size: 11px;
            }
            
            .study-table .meaning-cell {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ÏùºÎ≥∏Ïñ¥ Îã®Ïñ¥Ïû•</h1>
            <div class="header-buttons">
                <button class="header-btn hidden" id="homeBtn" onclick="goHome()">Ï≤òÏùåÏúºÎ°ú</button>
                <button class="header-btn hidden" id="changeSetBtn" onclick="changeWordSet()">Îã®Ïñ¥ÏÖã Î≥ÄÍ≤Ω</button>
            </div>
        </div>
        
        <div class="content">
            <!-- ÌååÏùº ÏÑ†ÌÉù ÌôîÎ©¥ -->
            <div id="fileSelectionScreen">
                <div class="file-selection">
                    <!-- Î™®Îìú ÏÑ†ÌÉù -->
                    <div class="mode-selection">
                        <label class="mode-option selected" onclick="selectMode('quiz')">
                            <input type="radio" name="studyMode" value="quiz" checked>
                            <div class="mode-icon">üìù</div>
                            <div class="mode-title">ÌèâÍ∞ÄÌïòÍ∏∞</div>
                            <div class="mode-description">ÎûúÎç§ Î¨∏Ï†úÎ°ú ÏïîÍ∏∞ ÌÖåÏä§Ìä∏</div>
                        </label>
                        <label class="mode-option" onclick="selectMode('study')">
                            <input type="radio" name="studyMode" value="study">
                            <div class="mode-icon">üìö</div>
                            <div class="mode-title">Í≥µÎ∂ÄÌïòÍ∏∞</div>
                            <div class="mode-description">Î™®Îì† Ï†ïÎ≥¥Î•º Î≥¥Î©∞ ÌïôÏäµ</div>
                        </label>
                    </div>
                    
                    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
                        <h3>üìÅ JSON ÌååÏùº ÏóÖÎ°úÎìú</h3>
                        <p style="margin-top: 10px; color: #666;">ÌÅ¥Î¶≠ÌïòÏó¨ Îã®Ïñ¥Î¨∂Ïùå ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
                        <input type="file" id="fileInput" accept=".json" multiple onchange="handleFileUpload(event)">
                    </div>
                    
                    <div id="fileListContainer" class="hidden">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Îã®Ïñ¥Î¨∂Ïùå Î™©Î°ù</h3>
                            <div>
                                <button class="btn-secondary" style="padding: 8px 16px; margin-right: 10px;" onclick="selectAll()">Ï†ÑÏ≤¥ÏÑ†ÌÉù</button>
                                <button class="btn-secondary" style="padding: 8px 16px;" onclick="deselectAll()">Ï†ÑÏ≤¥Ìï¥Ï†ú</button>
                            </div>
                        </div>
                        <div class="file-list" id="fileList"></div>
                        <div class="selection-controls" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="startStudy()">ÌïôÏäµ ÏãúÏûë</button>
                        </div>
                    </div>
                    
                    <div id="emptyState" class="empty-state">
                        <h2>Îã®Ïñ¥Î¨∂ÏùåÏù¥ ÏóÜÏäµÎãàÎã§</h2>
                        <p>ÏúÑÏùò ÏóÖÎ°úÎìú Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ JSON ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
            
            <!-- ÌîåÎûòÏãúÏπ¥Îìú ÌôîÎ©¥ -->
            <div id="flashcardScreen" class="hidden">
                <div class="flashcard">
                    <div class="card">
                        <div class="weight-badge" id="weightBadge">
                            Í∞ÄÏ§ëÏπò: <span class="weight-value" id="weightValue">1</span>
                        </div>
                        <div class="card-question" id="questionType"></div>
                        <div class="card-content" id="cardContent"></div>
                        <div class="card-answer hidden" id="cardAnswer"></div>
                    </div>
                    <div class="card-controls">
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousCard()" disabled>Ïù¥Ï†ÑÏúºÎ°ú</button>
                        <button class="btn btn-primary" id="showAnswerBtn" onclick="showAnswer()">Ï†ïÎãµ ÌôïÏù∏</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextCard()">Îã§ÏùåÏúºÎ°ú</button>
                    </div>
                </div>
            </div>
            
            <!-- Í≥µÎ∂ÄÌïòÍ∏∞ ÌÖåÏù¥Î∏î ÌôîÎ©¥ -->
            <div id="studyTableScreen" class="hidden">
                <div class="study-table-container" id="studyTableContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let wordSets = [];
        let selectedWords = [];
        let currentWordIndex = -1;
        let wordHistory = [];
        let currentQuestion = null;
        let answerShown = false;
        let weights = {};
        let studyMode = 'quiz'; // 'quiz' or 'study'
        
        // LocalStorage ÌÇ§
        const STORAGE_KEYS = {
            WORD_SETS: 'japanese_word_sets',
            WEIGHTS: 'japanese_word_weights'
        };
        
        // Í∏∞Î≥∏ Îã®Ïñ¥ Îç∞Ïù¥ÌÑ∞ (results Ìè¥ÎçîÏùò JSON ÌååÏùºÎì§)
        const DEFAULT_WORD_SETS = [
            {
                        "fileName": "page_01",
                        "words": [
                                    {
                                                "id": 1,
                                                "japanese": "ÊîπÊú≠",
                                                "pronunciation": "„Åã„ÅÑ„Åï„Å§",
                                                "meaning": "Í∞úÏ∞∞"
                                    },
                                    {
                                                "id": 2,
                                                "japanese": "‰æ°Ê†º",
                                                "pronunciation": "„Åã„Åã„Åè",
                                                "meaning": "Í∞ÄÍ≤©"
                                    },
                                    {
                                                "id": 3,
                                                "japanese": "ÂêÑÈßÖ",
                                                "pronunciation": "„Åã„Åè„Åà„Åç",
                                                "meaning": "Í∞ÅÏó≠"
                                    },
                                    {
                                                "id": 4,
                                                "japanese": "Ë¶≥ÂÆ¢",
                                                "pronunciation": "„Åã„Çì„Åç„ÇÉ„Åè",
                                                "meaning": "Í¥ÄÍ∞ù"
                                    },
                                    {
                                                "id": 5,
                                                "japanese": "ÂÆåÊàê",
                                                "pronunciation": "„Åã„Çì„Åõ„ÅÑ",
                                                "meaning": "ÏôÑÏÑ±"
                                    },
                                    {
                                                "id": 6,
                                                "japanese": "Ë°ÄÊ∂≤Âûã",
                                                "pronunciation": "„Åë„Å§„Åà„Åç„Åå„Åü",
                                                "meaning": "ÌòàÏï°Ìòï"
                                    },
                                    {
                                                "id": 7,
                                                "japanese": "ÊñπËßí",
                                                "pronunciation": "„Åª„ÅÜ„Åå„Åè",
                                                "meaning": "Î∞©Ìñ•"
                                    },
                                    {
                                                "id": 8,
                                                "japanese": "Èå≤Áîª",
                                                "pronunciation": "„Çç„Åè„Åå",
                                                "meaning": "ÎÖπÌôî"
                                    },
                                    {
                                                "id": 9,
                                                "japanese": "Âª∂Êúü",
                                                "pronunciation": "„Åà„Çì„Åç",
                                                "meaning": "Ïó∞Í∏∞"
                                    },
                                    {
                                                "id": 10,
                                                "japanese": "Ê∞óÊ∏©",
                                                "pronunciation": "„Åç„Åä„Çì",
                                                "meaning": "Í∏∞Ïò®"
                                    },
                                    {
                                                "id": 11,
                                                "japanese": "Ê©üÊ¢∞",
                                                "pronunciation": "„Åç„Åã„ÅÑ",
                                                "meaning": "Í∏∞Í≥Ñ"
                                    },
                                    {
                                                "id": 12,
                                                "japanese": "Ë≠∞‰ºö",
                                                "pronunciation": "„Åé„Åã„ÅÑ",
                                                "meaning": "ÏùòÌöå"
                                    },
                                    {
                                                "id": 13,
                                                "japanese": "ÁñëÂïè",
                                                "pronunciation": "„Åé„ÇÇ„Çì",
                                                "meaning": "ÏùòÎ¨∏"
                                    },
                                    {
                                                "id": 14,
                                                "japanese": "Ë°å‰∫ã",
                                                "pronunciation": "„Åé„Çá„ÅÜ„Åò",
                                                "meaning": "ÌñâÏÇ¨"
                                    },
                                    {
                                                "id": 15,
                                                "japanese": "Ë®ìÁ∑¥",
                                                "pronunciation": "„Åè„Çì„Çå„Çì",
                                                "meaning": "ÌõàÎ†®"
                                    },
                                    {
                                                "id": 16,
                                                "japanese": "‰∫àÁ¥Ñ",
                                                "pronunciation": "„Çà„ÇÑ„Åè",
                                                "meaning": "ÏòàÏïΩ"
                                    },
                                    {
                                                "id": 17,
                                                "japanese": "ÂÆ∂ÂÖ∑",
                                                "pronunciation": "„Åã„Åê",
                                                "meaning": "Í∞ÄÍµ¨"
                                    },
                                    {
                                                "id": 18,
                                                "japanese": "ÂÅ∂ÁÑ∂",
                                                "pronunciation": "„Åê„ÅÜ„Åú„Çì",
                                                "meaning": "Ïö∞Ïó∞"
                                    },
                                    {
                                                "id": 19,
                                                "japanese": "‰ºöË®à",
                                                "pronunciation": "„Åã„ÅÑ„Åë„ÅÑ",
                                                "meaning": "(ÎåÄÍ∏à)Í≥ÑÏÇ∞"
                                    },
                                    {
                                                "id": 20,
                                                "japanese": "ÁµåÂñ∂",
                                                "pronunciation": "„Åë„ÅÑ„Åà„ÅÑ",
                                                "meaning": "Í≤ΩÏòÅ"
                                    },
                                    {
                                                "id": 21,
                                                "japanese": "Â§ñÁßë",
                                                "pronunciation": "„Åí„Åã",
                                                "meaning": "Ïô∏Í≥º"
                                    },
                                    {
                                                "id": 22,
                                                "japanese": "ÊúàÊú´",
                                                "pronunciation": "„Åí„Å§„Åæ„Å§",
                                                "meaning": "ÏõîÎßê"
                                    },
                                    {
                                                "id": 23,
                                                "japanese": "ÁèæË±°",
                                                "pronunciation": "„Åí„Çì„Åó„Çá„ÅÜ",
                                                "meaning": "ÌòÑÏÉÅ"
                                    },
                                    {
                                                "id": 24,
                                                "japanese": "‰∏ä‰∏ã",
                                                "pronunciation": "„Åò„Çá„ÅÜ„Åí",
                                                "meaning": "ÏÉÅÌïò"
                                    },
                                    {
                                                "id": 25,
                                                "japanese": "Ë¨õÁæ©",
                                                "pronunciation": "„Åì„ÅÜ„Åé",
                                                "meaning": "Í∞ïÏùò"
                                    },
                                    {
                                                "id": 26,
                                                "japanese": "Â∑•‰∫ã",
                                                "pronunciation": "„Åì„ÅÜ„Åò",
                                                "meaning": "Í≥µÏÇ¨"
                                    },
                                    {
                                                "id": 27,
                                                "japanese": "Êï¨Ë™û",
                                                "pronunciation": "„Åë„ÅÑ„Åî",
                                                "meaning": "Í≤ΩÏñ¥"
                                    },
                                    {
                                                "id": 28,
                                                "japanese": "ÈõÜÂêà",
                                                "pronunciation": "„Åó„ÇÖ„ÅÜ„Åî„ÅÜ",
                                                "meaning": "ÏßëÌï©"
                                    },
                                    {
                                                "id": 29,
                                                "japanese": "ÂçòË™û",
                                                "pronunciation": "„Åü„Çì„Åî",
                                                "meaning": "Îã®Ïñ¥"
                                    },
                                    {
                                                "id": 30,
                                                "japanese": "Âõ£Â≠ê",
                                                "pronunciation": "„Å†„Çì„Åî",
                                                "meaning": "Í≤ΩÎã®"
                                    },
                                    {
                                                "id": 31,
                                                "japanese": "ÂâäÈô§",
                                                "pronunciation": "„Åï„Åè„Åò„Çá",
                                                "meaning": "ÏÇ≠Ï†ú"
                                    },
                                    {
                                                "id": 32,
                                                "japanese": "Âà∂‰Ωú",
                                                "pronunciation": "„Åõ„ÅÑ„Åï„Åè",
                                                "meaning": "Ï†úÏûë"
                                    },
                                    {
                                                "id": 33,
                                                "japanese": "ÊÆãÊ•≠",
                                                "pronunciation": "„Åñ„Çì„Åé„Çá„ÅÜ",
                                                "meaning": "ÏûîÏóÖ"
                                    },
                                    {
                                                "id": 34,
                                                "japanese": "Â≠òÂú®",
                                                "pronunciation": "„Åù„Çì„Åñ„ÅÑ",
                                                "meaning": "Ï°¥Ïû¨"
                                    },
                                    {
                                                "id": 35,
                                                "japanese": "ÊåáÁ§∫",
                                                "pronunciation": "„Åó„Åò",
                                                "meaning": "ÏßÄÏãú"
                                    },
                                    {
                                                "id": 36,
                                                "japanese": "ÊåáÂ∞é",
                                                "pronunciation": "„Åó„Å©„ÅÜ",
                                                "meaning": "ÏßÄÎèÑ"
                                    },
                                    {
                                                "id": 37,
                                                "japanese": "È¶ñÈÉΩ",
                                                "pronunciation": "„Åó„ÇÖ„Å®",
                                                "meaning": "ÏàòÎèÑ"
                                    },
                                    {
                                                "id": 38,
                                                "japanese": "Á∂≠ÊåÅ",
                                                "pronunciation": "„ÅÑ„Åò",
                                                "meaning": "Ïú†ÏßÄ"
                                    },
                                    {
                                                "id": 39,
                                                "japanese": "ÂÄã‰∫∫",
                                                "pronunciation": "„Åì„Åò„Çì",
                                                "meaning": "Í∞úÏù∏"
                                    },
                                    {
                                                "id": 40,
                                                "japanese": "ÊñáÂ≠ó",
                                                "pronunciation": "„ÇÇ„Åò",
                                                "meaning": "Î¨∏Ïûê"
                                    },
                                    {
                                                "id": 41,
                                                "japanese": "Áù°Áú†",
                                                "pronunciation": "„Åô„ÅÑ„Åø„Çì",
                                                "meaning": "ÏàòÎ©¥"
                                    },
                                    {
                                                "id": 42,
                                                "japanese": "Êï∞Â≠ó",
                                                "pronunciation": "„Åô„ÅÜ„Åò",
                                                "meaning": "Ïà´Ïûê"
                                    },
                                    {
                                                "id": 43,
                                                "japanese": "ÂêàÂõ≥",
                                                "pronunciation": "„ÅÇ„ÅÑ„Åö",
                                                "meaning": "Ïã†Ìò∏"
                                    },
                                    {
                                                "id": 44,
                                                "japanese": "Âõ≥",
                                                "pronunciation": "„Åö",
                                                "meaning": "Í∑∏Î¶º"
                                    },
                                    {
                                                "id": 45,
                                                "japanese": "È†≠Áóõ",
                                                "pronunciation": "„Åö„Å§„ÅÜ",
                                                "meaning": "ÎëêÌÜµ"
                                    },
                                    {
                                                "id": 46,
                                                "japanese": "Âú∞Âõ≥",
                                                "pronunciation": "„Å°„Åö",
                                                "meaning": "ÏßÄÎèÑ"
                                    },
                                    {
                                                "id": 47,
                                                "japanese": "ÊàêÁ∏æ",
                                                "pronunciation": "„Åõ„ÅÑ„Åõ„Åç",
                                                "meaning": "ÏÑ±Ï†Å"
                                    },
                                    {
                                                "id": 48,
                                                "japanese": "ÁØÄÁ¥Ñ",
                                                "pronunciation": "„Åõ„Å§„ÇÑ„Åè",
                                                "meaning": "Ï†àÏïΩ"
                                    },
                                    {
                                                "id": 49,
                                                "japanese": "Â∞ÇÈñÄÂÆ∂",
                                                "pronunciation": "„Åõ„Çì„ÇÇ„Çì„Åã",
                                                "meaning": "Ï†ÑÎ¨∏Í∞Ä"
                                    }
                        ]
            },
            {
                        "fileName": "page_02",
                        "words": [
                                    {
                                                "id": 1,
                                                "japanese": "‰ª•Ââç",
                                                "pronunciation": "„ÅÑ„Åú„Çì",
                                                "meaning": "Ïù¥Ï†Ñ"
                                    },
                                    {
                                                "id": 2,
                                                "japanese": "ÂÆåÂÖ®",
                                                "pronunciation": "„Åã„Çì„Åú„Çì",
                                                "meaning": "ÏôÑÏ†Ñ"
                                    },
                                    {
                                                "id": 3,
                                                "japanese": "Á®éÈáë",
                                                "pronunciation": "„Åú„ÅÑ„Åç„Çì",
                                                "meaning": "ÏÑ∏Í∏à"
                                    },
                                    {
                                                "id": 4,
                                                "japanese": "ÊÉ≥ÂÉè",
                                                "pronunciation": "„Åù„ÅÜ„Åû„ÅÜ",
                                                "meaning": "ÏÉÅÏÉÅ"
                                    },
                                    {
                                                "id": 5,
                                                "japanese": "Áõ∏Ë´á",
                                                "pronunciation": "„Åù„ÅÜ„Å†„Çì",
                                                "meaning": "ÏÉÅÎã¥"
                                    },
                                    {
                                                "id": 6,
                                                "japanese": "Ë£ΩÈÄ†",
                                                "pronunciation": "„Åõ„ÅÑ„Åû„ÅÜ",
                                                "meaning": "Ï†úÏ°∞"
                                    },
                                    {
                                                "id": 7,
                                                "japanese": "Â¢óÂä†",
                                                "pronunciation": "„Åû„ÅÜ„Åã",
                                                "meaning": "Ï¶ùÍ∞Ä"
                                    },
                                    {
                                                "id": 8,
                                                "japanese": "‰øùÂ≠ò",
                                                "pronunciation": "„Åª„Åû„Çì",
                                                "meaning": "Î≥¥Ï°¥"
                                    },
                                    {
                                                "id": 9,
                                                "japanese": "ÈÄ£Á∂ö",
                                                "pronunciation": "„Çå„Çì„Åû„Åè",
                                                "meaning": "Ïó∞ÏÜç"
                                    },
                                    {
                                                "id": 10,
                                                "japanese": "Ê¥óÊøØ",
                                                "pronunciation": "„Åõ„Çì„Åü„Åè",
                                                "meaning": "ÏÑ∏ÌÉÅ"
                                    },
                                    {
                                                "id": 11,
                                                "japanese": "Ê®™Êñ≠",
                                                "pronunciation": "„Åä„ÅÜ„Å†„Çì",
                                                "meaning": "Ìö°Îã®"
                                    },
                                    {
                                                "id": 12,
                                                "japanese": "Ê∏©Êöñ„Å†",
                                                "pronunciation": "„Åä„Çì„Å†„Çì„Å†",
                                                "meaning": "Ïò®ÎÇúÌïòÎã§"
                                    },
                                    {
                                                "id": 13,
                                                "japanese": "ÊâãÊÆµ",
                                                "pronunciation": "„Åó„ÇÖ„Å†„Çì",
                                                "meaning": "ÏàòÎã®"
                                    },
                                    {
                                                "id": 14,
                                                "japanese": "Áõ∏Êâã",
                                                "pronunciation": "„ÅÇ„ÅÑ„Å¶",
                                                "meaning": "ÏÉÅÎåÄ"
                                    },
                                    {
                                                "id": 15,
                                                "japanese": "ÊåáÂÆö",
                                                "pronunciation": "„Åó„Å¶„ÅÑ",
                                                "meaning": "ÏßÄÏ†ï"
                                    },
                                    {
                                                "id": 16,
                                                "japanese": "ÂÅúÈõª",
                                                "pronunciation": "„Å¶„ÅÑ„Åß„Çì",
                                                "meaning": "Ï†ïÏ†Ñ"
                                    },
                                    {
                                                "id": 17,
                                                "japanese": "ÈõªÊ∫ê",
                                                "pronunciation": "„Åß„Çì„Åí„Çì",
                                                "meaning": "Ï†ÑÏõê"
                                    },
                                    {
                                                "id": 18,
                                                "japanese": "‰ºùË®Ä",
                                                "pronunciation": "„Åß„Çì„Åî„Çì",
                                                "meaning": "Ï†ÑÏñ∏"
                                    },
                                    {
                                                "id": 19,
                                                "japanese": "‰ºùÈÅî",
                                                "pronunciation": "„Åß„Çì„Åü„Å§",
                                                "meaning": "Ï†ÑÎã¨"
                                    },
                                    {
                                                "id": 20,
                                                "japanese": "ÂúüÂú∞",
                                                "pronunciation": "„Å®„Å°",
                                                "meaning": "ÌÜ†ÏßÄ"
                                    },
                                    {
                                                "id": 21,
                                                "japanese": "ÂÜ∑Âáç",
                                                "pronunciation": "„Çå„ÅÑ„Å®„ÅÜ",
                                                "meaning": "ÎÉâÎèô"
                                    },
                                    {
                                                "id": 22,
                                                "japanese": "ÂêåÊÑè",
                                                "pronunciation": "„Å©„ÅÜ„ÅÑ",
                                                "meaning": "ÎèôÏùò"
                                    },
                                    {
                                                "id": 23,
                                                "japanese": "Áã¨Ë∫´",
                                                "pronunciation": "„Å©„Åè„Åó„Çì",
                                                "meaning": "ÎèÖÏã†"
                                    },
                                    {
                                                "id": 24,
                                                "japanese": "Áã¨Á´ã",
                                                "pronunciation": "„Å©„Åè„Çä„Å§",
                                                "meaning": "ÎèÖÎ¶Ω"
                                    },
                                    {
                                                "id": 25,
                                                "japanese": "Âä™Âäõ",
                                                "pronunciation": "„Å©„Çä„Çá„Åè",
                                                "meaning": "ÎÖ∏Î†•"
                                    },
                                    {
                                                "id": 26,
                                                "japanese": "ÈÖçÈÅî",
                                                "pronunciation": "„ÅØ„ÅÑ„Åü„Å§",
                                                "meaning": "Î∞∞Îã¨"
                                    },
                                    {
                                                "id": 27,
                                                "japanese": "Áô∫Â£≤",
                                                "pronunciation": "„ÅØ„Å§„Å∞„ÅÑ",
                                                "meaning": "Î∞úÎß§"
                                    },
                                    {
                                                "id": 28,
                                                "japanese": "ÁØÑÂõ≤",
                                                "pronunciation": "„ÅØ„Çì„ÅÑ",
                                                "meaning": "Î≤îÏúÑ"
                                    },
                                    {
                                                "id": 29,
                                                "japanese": "ÁúãÊùø",
                                                "pronunciation": "„Åã„Çì„Å∞„Çì",
                                                "meaning": "Í∞ÑÌåê"
                                    },
                                    {
                                                "id": 30,
                                                "japanese": "È†ÜÁï™",
                                                "pronunciation": "„Åò„ÇÖ„Çì„Å∞„Çì",
                                                "meaning": "ÏàúÎ≤à, Ï∞®Î°Ä"
                                    },
                                    {
                                                "id": 31,
                                                "japanese": "Â£≤Ë≤∑",
                                                "pronunciation": "„Å∞„ÅÑ„Å∞„ÅÑ",
                                                "meaning": "Îß§Îß§"
                                    },
                                    {
                                                "id": 32,
                                                "japanese": "Â§±Êïó",
                                                "pronunciation": "„Åó„Å£„Å±„ÅÑ",
                                                "meaning": "Ïã§Ìå®, Ïã§Ïàò"
                                    },
                                    {
                                                "id": 33,
                                                "japanese": "ÂøÉÈÖç",
                                                "pronunciation": "„Åó„Çì„Å±„ÅÑ",
                                                "meaning": "Í±±Ï†ï"
                                    },
                                    {
                                                "id": 34,
                                                "japanese": "Ê∂àË≤ª",
                                                "pronunciation": "„Åó„Çá„ÅÜ„Å≤",
                                                "meaning": "ÏÜåÎπÑ"
                                    },
                                    {
                                                "id": 35,
                                                "japanese": "‰∏ÄËà¨",
                                                "pronunciation": "„ÅÑ„Å£„Å±„Çì",
                                                "meaning": "ÏùºÎ∞ò"
                                    },
                                    {
                                                "id": 36,
                                                "japanese": "‰∏ÄÊñπ",
                                                "pronunciation": "„ÅÑ„Å£„ÅΩ„ÅÜ",
                                                "meaning": "ÌïúÏ™Ω, ÌïúÌé∏"
                                    },
                                    {
                                                "id": 37,
                                                "japanese": "Â≠¶Áßë",
                                                "pronunciation": "„Åå„Å£„Åã",
                                                "meaning": "ÌïôÍ≥º"
                                    },
                                    {
                                                "id": 38,
                                                "japanese": "Ê¥ªÊ∞ó",
                                                "pronunciation": "„Åã„Å£„Åç",
                                                "meaning": "ÌôúÍ∏∞"
                                    },
                                    {
                                                "id": 39,
                                                "japanese": "Ê•ΩÂô®",
                                                "pronunciation": "„Åå„Å£„Åç",
                                                "meaning": "ÏïÖÍ∏∞"
                                    },
                                    {
                                                "id": 40,
                                                "japanese": "ÂêÑÂõΩ",
                                                "pronunciation": "„Åã„Å£„Åì„Åè",
                                                "meaning": "Í∞ÅÍµ≠"
                                    },
                                    {
                                                "id": 41,
                                                "japanese": "ÁµêÊûú",
                                                "pronunciation": "„Åë„Å£„Åã",
                                                "meaning": "Í≤∞Í≥º"
                                    },
                                    {
                                                "id": 42,
                                                "japanese": "Ê±∫ÂøÉ",
                                                "pronunciation": "„Åë„Å£„Åó„Çì",
                                                "meaning": "Í≤∞Ïã¨"
                                    },
                                    {
                                                "id": 43,
                                                "japanese": "ÂõΩ‰ºö",
                                                "pronunciation": "„Åì„Å£„Åã„ÅÑ",
                                                "meaning": "Íµ≠Ìöå"
                                    },
                                    {
                                                "id": 44,
                                                "japanese": "‰ΩúÊõ≤",
                                                "pronunciation": "„Åï„Å£„Åç„Çá„Åè",
                                                "meaning": "ÏûëÍ≥°"
                                    },
                                    {
                                                "id": 45,
                                                "japanese": "ÂÆüÂÆ∂",
                                                "pronunciation": "„Åò„Å£„Åã",
                                                "meaning": "Î≥∏Í∞Ä, ÏπúÏ†ï"
                                    },
                                    {
                                                "id": 46,
                                                "japanese": "ÂÆüÈ®ì",
                                                "pronunciation": "„Åò„Å£„Åë„Çì",
                                                "meaning": "Ïã§Ìóò"
                                    },
                                    {
                                                "id": 47,
                                                "japanese": "ÂÄüÈáë",
                                                "pronunciation": "„Åó„ÇÉ„Å£„Åç„Çì",
                                                "meaning": "Ï∞®Í∏à, Îπõ"
                                    },
                                    {
                                                "id": 48,
                                                "japanese": "Âá∫Ë∫´",
                                                "pronunciation": "„Åó„ÇÖ„Å£„Åó„Çì",
                                                "meaning": "Ï∂úÏã†"
                                    }
                        ]
            }
];
        // Ï¥àÍ∏∞Ìôî
        function init() {
            loadFromStorage();
            
            // DEFAULT_WORD_SETSÏùò ÌååÏùºÎ™Ö Î™©Î°ù
            const defaultFileNames = new Set(DEFAULT_WORD_SETS.map(set => set.fileName));
            
            // LocalStorageÏóê Ï†ÄÏû•Îêú ÌååÏùºÎ™Ö Î™©Î°ù
            const storedFileNames = new Set(wordSets.map(set => set.fileName));
            
            // DEFAULT_WORD_SETSÏóê ÏûàÎäî Î™®Îì† ÌååÏùºÏù¥ LocalStorageÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
            let allDefaultFilesExist = true;
            for (const fileName of defaultFileNames) {
                if (!storedFileNames.has(fileName)) {
                    allDefaultFilesExist = false;
                    break;
                }
            }
            
            // LocalStorageÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò, DEFAULT_WORD_SETSÏôÄ Í∞úÏàòÍ∞Ä Îã§Î•¥Í±∞ÎÇò,
            // DEFAULT_WORD_SETSÏóê ÏûàÎäî ÌååÏùºÏù¥ LocalStorageÏóê ÏóÜÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            const needsUpdate = wordSets.length === 0 || 
                               DEFAULT_WORD_SETS.length !== wordSets.length ||
                               !allDefaultFilesExist;
            
            if (needsUpdate) {
                // DEFAULT_WORD_SETSÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                // Í∏∞Ï°¥ Í∞ÄÏ§ëÏπòÎäî Ïú†ÏßÄÌïòÍ≥†, ÏÉà Îã®Ïñ¥Îßå Í∞ÄÏ§ëÏπò Ï¥àÍ∏∞Ìôî
                DEFAULT_WORD_SETS.forEach(set => {
                    const existingIndex = wordSets.findIndex(s => s.fileName === set.fileName);
                    if (existingIndex >= 0) {
                        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ (Í∞ÄÏ§ëÏπòÎäî Ïú†ÏßÄ)
                        wordSets[existingIndex] = set;
                    } else {
                        // ÏÉà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                        wordSets.push(set);
                    }
                    
                    // ÏÉà Îã®Ïñ¥Îì§Ïùò Í∞ÄÏ§ëÏπò Ï¥àÍ∏∞Ìôî
                    set.words.forEach(word => {
                        const key = `${set.fileName}_${word.id}`;
                        if (!weights[key]) {
                            weights[key] = 1;
                        }
                    });
                });
                
                // DEFAULT_WORD_SETSÏóê ÏóÜÎäî ÌååÏùºÏùÄ Ï†úÍ±∞
                wordSets = wordSets.filter(set => defaultFileNames.has(set.fileName));
                
                saveToStorage();
            }
            
            renderFileList();
        }
        
        // LocalStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadFromStorage() {
            const savedSets = localStorage.getItem(STORAGE_KEYS.WORD_SETS);
            const savedWeights = localStorage.getItem(STORAGE_KEYS.WEIGHTS);
            
            if (savedSets) {
                wordSets = JSON.parse(savedSets);
            }
            
            if (savedWeights) {
                weights = JSON.parse(savedWeights);
            }
        }
        
        // LocalStorageÏóê Ï†ÄÏû•
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEYS.WORD_SETS, JSON.stringify(wordSets));
            localStorage.setItem(STORAGE_KEYS.WEIGHTS, JSON.stringify(weights));
        }
        
        // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        async function handleFileUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (ÌååÏùºÎ™ÖÏúºÎ°ú)
                    const existingIndex = wordSets.findIndex(set => set.fileName === data.fileName);
                    if (existingIndex >= 0) {
                        wordSets[existingIndex] = data;
                    } else {
                        wordSets.push(data);
                    }
                    
                    // ÏÉà Îã®Ïñ¥Îì§Ïùò Í∞ÄÏ§ëÏπò Ï¥àÍ∏∞Ìôî
                    data.words.forEach(word => {
                        const key = `${data.fileName}_${word.id}`;
                        if (!weights[key]) {
                            weights[key] = 1;
                        }
                    });
                } catch (error) {
                    alert(`ÌååÏùº "${file.name}" Î°úÎìú Ïã§Ìå®: ${error.message}`);
                }
            }
            
            saveToStorage();
            renderFileList();
            event.target.value = ''; // Í∞ôÏùÄ ÌååÏùº Ïû¨ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÎèÑÎ°ù
        }
        
        // Î™®Îìú ÏÑ†ÌÉù
        function selectMode(mode) {
            studyMode = mode;
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÎ°ú Î∞îÎÄåÎ©¥ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
            if (mode === 'study') {
                deselectAll();
            }
        }
        
        // ÌååÏùº Î™©Î°ù Î†åÎçîÎßÅ
        function renderFileList() {
            const fileList = document.getElementById('fileList');
            const fileListContainer = document.getElementById('fileListContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (wordSets.length === 0) {
                fileListContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            fileListContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // fileName ÏàúÏúºÎ°ú Ï†ïÎ†¨ (Ïà´Ïûê Î∂ÄÎ∂ÑÏùÑ Í≥†Î†§Ìïú ÏûêÏó∞ Ï†ïÎ†¨)
            const sortedWordSets = [...wordSets].sort((a, b) => {
                // fileNameÏóêÏÑú Ïà´Ïûê Î∂ÄÎ∂Ñ Ï∂îÏ∂ú
                const numA = parseInt(a.fileName.match(/\d+/)?.[0] || '0', 10);
                const numB = parseInt(b.fileName.match(/\d+/)?.[0] || '0', 10);
                return numA - numB;
            });
            
            fileList.innerHTML = sortedWordSets.map((set, index) => {
                // ÏõêÎ≥∏ Î∞∞Ïó¥ÏóêÏÑúÏùò Ïù∏Îç±Ïä§ Ï∞æÍ∏∞
                const originalIndex = wordSets.findIndex(s => s.fileName === set.fileName);
                return `
                <div class="file-item" onclick="toggleFileSelection(${originalIndex}, event)">
                    <input type="checkbox" id="file_${originalIndex}" onclick="event.stopPropagation()">
                    <div class="file-item-info">
                        <div class="file-item-name">${set.fileName}</div>
                        <div class="file-item-count">${set.words.length}Í∞ú Îã®Ïñ¥</div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // ÌååÏùº ÏÑ†ÌÉù ÌÜ†Í∏Ä
        function toggleFileSelection(index, event) {
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏßÅÏ†ë ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Îäî Ïù¥ÎØ∏ ÌÜ†Í∏ÄÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú ÏïÑÎ¨¥Í≤ÉÎèÑ ÏïàÌï®
            if (event && event.target.type === 'checkbox') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÎßå ÏÑ†ÌÉùÎêòÎèÑÎ°ù
                if (studyMode === 'study') {
                    const checkbox = event.target;
                    if (checkbox.checked) {
                        // Îã§Î•∏ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú
                        wordSets.forEach((_, i) => {
                            if (i !== index) {
                                document.getElementById(`file_${i}`).checked = false;
                            }
                        });
                    }
                }
                return;
            }
            
            const checkbox = document.getElementById(`file_${index}`);
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÎßå ÏÑ†ÌÉùÎêòÎèÑÎ°ù
            if (studyMode === 'study') {
                if (checkbox.checked) {
                    // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ Ìï¥Ï†ú
                    checkbox.checked = false;
                } else {
                    // Îã§Î•∏ Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†ú ÌõÑ ÌòÑÏû¨ Í≤ÉÎßå ÏÑ†ÌÉù
                    wordSets.forEach((_, i) => {
                        document.getElementById(`file_${i}`).checked = false;
                    });
                    checkbox.checked = true;
                }
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî Í∏∞Ï°¥ÎåÄÎ°ú ÌÜ†Í∏Ä
            checkbox.checked = !checkbox.checked;
            }
        }
        
        // Ï†ÑÏ≤¥ ÏÑ†ÌÉù
        function selectAll() {
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî Ï†ÑÏ≤¥ ÏÑ†ÌÉù Î∂àÍ∞Ä
            if (studyMode === 'study') {
                alert('Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑúÎäî ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            wordSets.forEach((_, index) => {
                document.getElementById(`file_${index}`).checked = true;
            });
        }
        
        // Ï†ÑÏ≤¥ Ìï¥Ï†ú
        function deselectAll() {
            wordSets.forEach((_, index) => {
                document.getElementById(`file_${index}`).checked = false;
            });
        }
        
        // ÌïôÏäµ ÏãúÏûë
        function startStudy() {
            selectedWords = [];
            let selectedFileCount = 0;
            let selectedSet = null;
            
            wordSets.forEach((set, index) => {
                const checkbox = document.getElementById(`file_${index}`);
                if (checkbox && checkbox.checked) {
                    selectedFileCount++;
                    selectedSet = set;
                    set.words.forEach(word => {
                        selectedWords.push({
                            ...word,
                            fileName: set.fileName,
                            weightKey: `${set.fileName}_${word.id}`
                        });
                    });
                }
            });
            
            if (selectedWords.length === 0) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏùº ÎïåÎäî ÌïòÎÇòÏùò ÌååÏùºÎßå ÏÑ†ÌÉùÎêòÏñ¥Ïïº Ìï®
            if (studyMode === 'study' && selectedFileCount > 1) {
                alert('Í≥µÎ∂ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑúÎäî ÌïòÎÇòÏùò Îã®Ïñ¥Î¨∂ÏùåÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            currentWordIndex = -1;
            wordHistory = [];
            
            document.getElementById('fileSelectionScreen').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
            document.getElementById('changeSetBtn').classList.remove('hidden');
            
            if (studyMode === 'study') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: ÌÖåÏù¥Î∏î ÌôîÎ©¥ ÌëúÏãú
                displayStudyTable(selectedSet);
                document.getElementById('studyTableScreen').classList.remove('hidden');
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: ÌîåÎûòÏãúÏπ¥Îìú ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('flashcardScreen').classList.remove('hidden');
            nextCard();
            }
        }
        
        // Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ Îã®Ïñ¥ ÏÑ†ÌÉù
        function getWeightedRandomWord() {
            const totalWeight = selectedWords.reduce((sum, word) => {
                return sum + (weights[word.weightKey] || 1);
            }, 0);
            
            let random = Math.random() * totalWeight;
            
            for (let word of selectedWords) {
                const weight = weights[word.weightKey] || 1;
                random -= weight;
                if (random <= 0) {
                    return word;
                }
            }
            
            return selectedWords[0];
        }
        
        // Îã§Ïùå Ïπ¥Îìú
        function nextCard() {
            // Í∞ÄÏ§ëÏπò ÏóÖÎç∞Ïù¥Ìä∏
            if (currentWordIndex >= 0) {
                const currentWord = wordHistory[currentWordIndex];
                if (studyMode === 'study') {
                    // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Ìï≠ÏÉÅ Í∞ÄÏ§ëÏπò Ï¶ùÍ∞Ä
                    weights[currentWord.weightKey] = Math.min(5, (weights[currentWord.weightKey] || 1) + 1);
                } else if (!answerShown) {
                    // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: Ï†ïÎãµ ÌôïÏù∏ ÏïàÌïòÍ≥† ÎÑòÏñ¥Í∞ê
                    weights[currentWord.weightKey] = Math.max(1, (weights[currentWord.weightKey] || 1) - 1);
                }
                saveToStorage();
            }
            
            const newWord = getWeightedRandomWord();
            wordHistory.push(newWord);
            currentWordIndex = wordHistory.length - 1;
            
            displayCard();
            updateButtons();
        }
        
        // Ïù¥Ï†Ñ Ïπ¥Îìú
        function previousCard() {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                displayCard();
                updateButtons();
            }
        }
        
        // Ïπ¥Îìú ÌëúÏãú
        function displayCard() {
            const word = wordHistory[currentWordIndex];
            answerShown = false;
            
            // ÌòÑÏû¨ Îã®Ïñ¥Ïùò Í∞ÄÏ§ëÏπò ÌëúÏãú
            const currentWeight = weights[word.weightKey] || 1;
            document.getElementById('weightValue').textContent = currentWeight;
            
            if (studyMode === 'study') {
                // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú: Î™®Îì† Ï†ïÎ≥¥ ÌëúÏãú
                displayStudyMode(word);
            } else {
                // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú: ÎûúÎç§ Î¨∏Ï†ú
                displayQuizMode(word);
            }
        }
        
        // ÌèâÍ∞ÄÌïòÍ∏∞ Î™®Îìú ÌëúÏãú
        function displayQuizMode(word) {
            // Î∞úÏùåÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (Îπà Î¨∏ÏûêÏó¥Ïù¥Í±∞ÎÇò ÏóÜÎäî Í≤ΩÏö∞ Ï†úÏô∏)
            const hasPronunciation = word.pronunciation && word.pronunciation.trim() !== '';
            
            // ÎûúÎç§ÏúºÎ°ú Î¨∏Ï†ú Ïú†Ìòï ÏÑ†ÌÉù (Î∞úÏùåÏù¥ ÏóÜÏúºÎ©¥ Î∞úÏùå Î¨∏Ï†ú Ï†úÏô∏)
            const questionTypes = [
                { type: 'japanese', label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞', value: word.japanese },
                { type: 'meaning', label: 'Îúª', value: word.meaning }
            ];
            
            // Î∞úÏùåÏù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå Î∞úÏùå Î¨∏Ï†ú Ï∂îÍ∞Ä
            if (hasPronunciation) {
                questionTypes.splice(1, 0, { type: 'pronunciation', label: 'Î∞úÏùå', value: word.pronunciation });
            }
            
            const randomIndex = Math.floor(Math.random() * questionTypes.length);
            currentQuestion = questionTypes[randomIndex];
            
            document.getElementById('questionType').textContent = currentQuestion.label;
            document.getElementById('cardContent').textContent = currentQuestion.value;
            document.getElementById('cardContent').style.fontSize = '48px';
            document.getElementById('cardAnswer').classList.add('hidden');
            document.getElementById('showAnswerBtn').classList.remove('hidden');
            document.getElementById('nextBtn').textContent = 'Îã§ÏùåÏúºÎ°ú';
        }
        
        // Í≥µÎ∂ÄÌïòÍ∏∞ ÌÖåÏù¥Î∏î ÌëúÏãú
        function displayStudyTable(wordSet) {
            const container = document.getElementById('studyTableContainer');
            
            const tableHTML = `
                <table class="study-table">
                    <thead>
                        <tr>
                            <th class="id-cell">ID</th>
                            <th class="japanese-cell">ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞</th>
                            <th class="pronunciation-cell">Î∞úÏùå</th>
                            <th class="meaning-cell">ÏùòÎØ∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${wordSet.words.map(word => `
                            <tr>
                                <td class="id-cell">${word.id}</td>
                                <td class="japanese-cell">${word.japanese}</td>
                                <td class="pronunciation-cell">${word.pronunciation}</td>
                                <td class="meaning-cell">${word.meaning}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        // Í≥µÎ∂ÄÌïòÍ∏∞ Î™®Îìú ÌëúÏãú (ÌèâÍ∞ÄÌïòÍ∏∞ Î™®ÎìúÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî Ìï®Ïàò - Ïú†ÏßÄ)
        function displayStudyMode(word) {
            currentQuestion = { type: 'all' }; // Î™®Îì† Ï†ïÎ≥¥ ÌëúÏãú
            
            document.getElementById('questionType').textContent = 'Í≥µÎ∂ÄÌïòÍ∏∞';
            
            const studyHTML = `
                <div class="study-mode-card">
                    <div class="study-item main">
                        <div class="study-item-label">ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞</div>
                        <div class="study-item-value">${word.japanese}</div>
                    </div>
                    <div class="study-item">
                        <div class="study-item-label">Î∞úÏùå</div>
                        <div class="study-item-value">${word.pronunciation}</div>
                    </div>
                    <div class="study-item">
                        <div class="study-item-label">Îúª</div>
                        <div class="study-item-value">${word.meaning}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('cardContent').innerHTML = studyHTML;
            document.getElementById('cardContent').style.fontSize = 'inherit';
            document.getElementById('cardAnswer').classList.add('hidden');
            document.getElementById('showAnswerBtn').classList.add('hidden');
            document.getElementById('nextBtn').textContent = 'Îã§ÏùåÏúºÎ°ú';
        }
        
        // Ï†ïÎãµ ÌôïÏù∏
        function showAnswer() {
            const word = wordHistory[currentWordIndex];
            answerShown = true;
            
            // Í∞ÄÏ§ëÏπò Ï¶ùÍ∞Ä
            weights[word.weightKey] = Math.min(5, (weights[word.weightKey] || 1) + 1);
            saveToStorage();
            
            // Î∞úÏùåÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            const hasPronunciation = word.pronunciation && word.pronunciation.trim() !== '';
            
            // ÎÇòÎ®∏ÏßÄ Ï†ïÎ≥¥ ÌëúÏãú
            const answers = [];
            if (currentQuestion.type !== 'japanese') {
                answers.push({ label: 'ÏùºÎ≥∏Ïñ¥ ÌëúÍ∏∞', value: word.japanese });
            }
            if (currentQuestion.type !== 'pronunciation' && hasPronunciation) {
                answers.push({ label: 'Î∞úÏùå', value: word.pronunciation });
            }
            if (currentQuestion.type !== 'meaning') {
                answers.push({ label: 'Îúª', value: word.meaning });
            }
            
            const answerHTML = answers.map(ans => `
                <div class="card-answer-item">
                    <div class="card-answer-label">${ans.label}</div>
                    <div class="card-answer-value">${ans.value}</div>
                </div>
            `).join('');
            
            document.getElementById('cardAnswer').innerHTML = answerHTML;
            document.getElementById('cardAnswer').classList.remove('hidden');
            document.getElementById('showAnswerBtn').classList.add('hidden');
        }
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateButtons() {
            document.getElementById('prevBtn').disabled = currentWordIndex === 0;
        }
        
        // Ï≤òÏùåÏúºÎ°ú
        function goHome() {
            if (confirm('ÌïôÏäµÏùÑ Ï¢ÖÎ£åÌïòÍ≥† Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById('flashcardScreen').classList.add('hidden');
                document.getElementById('studyTableScreen').classList.add('hidden');
                document.getElementById('fileSelectionScreen').classList.remove('hidden');
                document.getElementById('homeBtn').classList.add('hidden');
                document.getElementById('changeSetBtn').classList.add('hidden');
            }
        }
        
        // Îã®Ïñ¥ÏÖã Î≥ÄÍ≤Ω
        function changeWordSet() {
            if (confirm('ÌòÑÏû¨ ÌïôÏäµÏùÑ Ï§ëÎã®ÌïòÍ≥† Îã®Ïñ¥ÏÖãÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById('flashcardScreen').classList.add('hidden');
                document.getElementById('studyTableScreen').classList.add('hidden');
                document.getElementById('fileSelectionScreen').classList.remove('hidden');
                document.getElementById('changeSetBtn').classList.add('hidden');
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = init;
    </script>
</body>
</html>